<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal del Acudiente - I.E. De María</title>

  <!-- PWA -->
  <link rel="manifest" href="/Observacionesycontroldeausentismoescolar/manifest.json">
  <meta name="theme-color" content="#1b5e20">

  <style>
    body { margin: 0; background: #dff5e1; font-family: Arial, sans-serif; padding-bottom: 80px; }
    .header { background: #1b5e20; color: white; padding: 20px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
    .header img { width: 90px; margin-bottom: 10px; }
    .menu { display: flex; justify-content: space-around; background: #2e7d32; padding: 10px; border-radius: 30px; width: 90%; margin: 20px auto; }
    .menu button { background: white; color: #2e7d32; border: none; padding: 12px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    .menu button.active { background: #1b5e20; color: white; }
    .container { background: white; width: 90%; margin: 10px auto; padding: 15px; border-radius: 15px; box-shadow: 0px 2px 5px rgba(0,0,0,0.2); }
    h3 { margin-top: 0; }
    input, select, textarea { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: 1px solid #aaa; font-size: 15px; }
    textarea { resize: none; min-height: 120px; }
    .btn { margin-top: 15px; width: 100%; padding: 15px; background: #1b5e20; color: white; font-weight: bold; border-radius: 10px; border: none; cursor: pointer; font-size: 15px; }
    .btn.secundario { background: #444; }
    .btn:hover { opacity: 0.95; }
    .signature-container { margin-top: 15px; background: #f5f5f5; padding: 10px; border-radius: 10px; }
    canvas { width: 100%; height: 200px; background: white; border-radius: 10px; border: 2px solid #ccc; touch-action: none; }
    .footer-text { margin: 20px; font-size: 16px; font-weight: bold; color: #145018; text-align: center; }
    .info-text { margin-top: 10px; color: #555; }
    .resumen-observaciones > div { border-bottom: 1px solid #ddd; padding: 10px 0; font-size: 14px; }
  </style>

  <!-- FIREBASE (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
      authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
      projectId: "diariodeprocesos-6f78d",
      storageBucket: "diariodeprocesos-6f78d.appspot.com",
      messagingSenderId: "487922338632",
      appId: "1:487922338632:web:47fc48c23dbea064b0817d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ✅ COLECCIONES IGUAL QUE APP DOCENTE
    const COL_REGISTROS = "registrosComportamentales";
    const COL_EXCUSAS   = "excusasInasistencia";
    const COL_ESTUDIANTES = "estudiantes"; // opcional (si existe)
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/Observacionesycontroldeausentismoescolar/sw.js")
        .catch(err => console.log("Error SW:", err));
    }
  </script>
</head>

<body>
  <div class="header">
    <img src="/Observacionesycontroldeausentismoescolar/escudo.png" alt="Escudo I.E. De María">
    <h2>Institución Educativa de María</h2>
    <h3>Sede Rural Santa Juana (Primaria) – 2026</h3>
    <strong>Docente: Oscar Barrientos</strong>
  </div>

  <div class="menu">
    <button id="btnObs" class="active" onclick="mostrarObservaciones()">Consultar observaciones</button>
    <button id="btnExc" onclick="mostrarExcusas()">Enviar excusa</button>
  </div>

  <div id="observaciones" class="container">
    <h3>Documento del estudiante</h3>
    <input type="number" id="docObs" placeholder="Ej: 15271403">
    <div class="info-text">Digite el número de documento del estudiante para ver las observaciones registradas.</div>
    <button class="btn" onclick="buscarObservaciones()">Buscar observaciones</button>
    <div id="resultadoObs" class="resumen-observaciones"></div>
  </div>

  <div id="excusas" class="container" style="display:none;">
    <h3>Documento del estudiante</h3>
    <input type="number" id="docExc" placeholder="Ej: 15271403">
    <div class="info-text">Digite el número de documento del estudiante para registrar una excusa de inasistencia.</div>
    <button class="btn" onclick="mostrarFormularioExcusa()">Continuar</button>

    <div id="formExcusa" style="display:none; margin-top:20px;">
      <div id="nombreEstudiante" style="margin-bottom:10px; font-weight:bold;"></div>

      <h3>Fecha de inasistencia</h3>
      <input type="date" id="fechaExc">

      <h3>Motivo</h3>
      <select id="motivo">
        <option value="Enfermedad">Enfermedad</option>
        <option value="Cita médica">Cita médica</option>
        <option value="Calamidad">Calamidad</option>
        <option value="Otro">Otro (especifique)</option>
      </select>

      <textarea id="detalleMotivo" placeholder="Especifique aquí la razón de la inasistencia"></textarea>

      <h3>Firma del acudiente</h3>
      <div class="signature-container">
        <canvas id="firmaPad"></canvas>
        <button type="button" class="btn secundario" onclick="limpiarFirma()">Limpiar firma</button>
      </div>

      <button class="btn" onclick="enviarExcusa()">Enviar excusa</button>
    </div>
  </div>

  <div class="footer-text">
    “Familia y escuela caminamos juntos: al colaborar y comunicarnos, construimos el mejor camino para el bienestar y aprendizaje de nuestros hijos.”
  </div>

  <script>
    function mostrarObservaciones() {
      document.getElementById("observaciones").style.display = "block";
      document.getElementById("excusas").style.display = "none";
      document.getElementById("btnObs").classList.add("active");
      document.getElementById("btnExc").classList.remove("active");
    }

    function mostrarExcusas() {
      document.getElementById("observaciones").style.display = "none";
      document.getElementById("excusas").style.display = "block";
      document.getElementById("btnExc").classList.add("active");
      document.getElementById("btnObs").classList.remove("active");
    }

    // ----- Firma (canvas) -----
    let canvas = document.getElementById("firmaPad");
    let ctx = canvas.getContext("2d");
    let dibujando = false;
    let lastX = 0;
    let lastY = 0;

    function ajustarCanvasFirma() {
      const formVisible = document.getElementById("formExcusa").style.display !== "none";
      if (!formVisible) return;

      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = 200;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000000";
    }

    function empezarDibujo(x, y) { dibujando = true; [lastX, lastY] = [x, y]; }
    function dibujarLinea(x, y) {
      if (!dibujando) return;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      [lastX, lastY] = [x, y];
    }
    function detenerDibujo() { dibujando = false; }

    canvas.addEventListener("mousedown", (e) => {
      const rect = canvas.getBoundingClientRect();
      empezarDibujo(e.clientX - rect.left, e.clientY - rect.top);
    });
    canvas.addEventListener("mousemove", (e) => {
      const rect = canvas.getBoundingClientRect();
      dibujarLinea(e.clientX - rect.left, e.clientY - rect.top);
    });
    canvas.addEventListener("mouseup", detenerDibujo);
    canvas.addEventListener("mouseleave", detenerDibujo);

    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const t = e.touches[0];
      empezarDibujo(t.clientX - rect.left, t.clientY - rect.top);
    });
    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const t = e.touches[0];
      dibujarLinea(t.clientX - rect.left, t.clientY - rect.top);
    });
    canvas.addEventListener("touchend", detenerDibujo);
    canvas.addEventListener("touchcancel", detenerDibujo);

    function limpiarFirma() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    window.addEventListener("resize", ajustarCanvasFirma);

    // ----- Observaciones (CORREGIDO) -----
    async function buscarObservaciones() {
      const docu = document.getElementById("docObs").value.trim();
      const resDiv = document.getElementById("resultadoObs");

      if (!docu) {
        alert("Por favor, digite el documento del estudiante.");
        return;
      }

      resDiv.innerHTML = "<em>Cargando observaciones...</em>";

      try {
        // ✅ CAMBIO: documentoEstudiante (igual que app docente)
        const snap = await db.collection(COL_REGISTROS)
          .where("documentoEstudiante", "==", docu)
          .get();

        if (snap.empty) {
          resDiv.innerHTML = "<strong>No hay observaciones registradas para este documento.</strong>";
          return;
        }

        let html = "";
        snap.forEach(d => {
          const r = d.data() || {};
          html += `
            <div>
              <strong>Fecha:</strong> ${r.fecha || ""}<br>
              <strong>Comportamiento:</strong> ${r.comportamiento || ""}<br>
              <strong>Descargos:</strong> ${r.descargos || ""}<br>
              <strong>Procedimiento:</strong> ${r.procedimiento || ""}<br>
              <strong>Firma acudiente:</strong> ${r.firmaAcudiente ? "Registrada" : "Pendiente"}
            </div>
          `;
        });

        resDiv.innerHTML = html;
      } catch (err) {
        console.error(err);
        resDiv.innerHTML = "<strong>Ocurrió un error al buscar las observaciones.</strong>";
      }
    }

    // ----- Excusas (CORREGIDO) -----
    async function mostrarFormularioExcusa() {
      const docu = document.getElementById("docExc").value.trim();
      const nombreDiv = document.getElementById("nombreEstudiante");
      const form = document.getElementById("formExcusa");

      if (!docu) {
        alert("Por favor, digite el documento del estudiante.");
        return;
      }

      form.style.display = "block";

      // Intento 1: buscar en colección estudiantes (si existe)
      try {
        const est = await db.collection(COL_ESTUDIANTES).where("documento", "==", docu).limit(1).get();
        if (!est.empty) {
          nombreDiv.textContent = "Estudiante: " + (est.docs[0].data().nombre || "(sin nombre)");
        } else {
          // Intento 2: buscar en registros (como hacías)
          const snap = await db.collection(COL_REGISTROS)
            .where("documentoEstudiante", "==", docu)
            .limit(1)
            .get();

          if (!snap.empty) {
            const datos = snap.docs[0].data() || {};
            nombreDiv.textContent = "Estudiante: " + (datos.nombreEstudiante || "(sin nombre registrado)");
          } else {
            nombreDiv.textContent = "Estudiante: (no encontrado, pero puede enviar la excusa)";
          }
        }
      } catch (err) {
        console.error(err);
        nombreDiv.textContent = "Estudiante: (no se pudo verificar el nombre, pero puede enviar la excusa)";
      }

      setTimeout(ajustarCanvasFirma, 50);
    }

    async function enviarExcusa() {
      const docu = document.getElementById("docExc").value.trim();
      const fecha = document.getElementById("fechaExc").value;
      const motivo = document.getElementById("motivo").value;
      const detalle = document.getElementById("detalleMotivo").value.trim();

      if (!docu || !fecha || !motivo || !detalle) {
        alert("Por favor, complete todos los campos de la excusa.");
        return;
      }

      const firmaImg = canvas.toDataURL("image/png");

      try {
        // ✅ GUARDA EXACTO COMO LEE EL DOCENTE
        await db.collection(COL_EXCUSAS).add({
          documentoEstudiante: docu,
          fechaInasistencia: fecha,
          motivoTipo: motivo,
          motivoDetalle: detalle,
          firmaAcudiente: firmaImg,
          fechaEnvio: new Date().toISOString()
        });

        alert(
          "Excusa enviada correctamente.\n\n" +
          "Recuerde que es obligación del estudiante ponerse al día con las actividades delegadas " +
          "durante su ausencia."
        );

        document.getElementById("fechaExc").value = "";
        document.getElementById("motivo").value = "Enfermedad";
        document.getElementById("detalleMotivo").value = "";
        limpiarFirma();
      } catch (err) {
        console.error(err);
        alert("Ocurrió un error al enviar la excusa. Intente nuevamente.");
      }
    }
  </script>

</body>
</html>
