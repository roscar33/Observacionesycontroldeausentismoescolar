<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal del Acudiente - I.E. De Mar√≠a</title>

  <!-- PWA -->
  <link rel="manifest" href="/Observacionesycontroldeausentismoescolar/manifest.json">
  <meta name="theme-color" content="#1b5e20">

  <style>
    :root{
      --green:#1b5e20;
      --green2:#2e7d32;
      --bg:#dff5e1;
      --card:#ffffff;
      --text:#0b1f12;
      --muted:#4b5563;
      --shadow:0 10px 25px rgba(0,0,0,.12);
      --radius:18px;

      --lvl1:#16a34a; /* verde */
      --lvl2:#f59e0b; /* naranja */
      --lvl3:#dc2626; /* rojo */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding-bottom: 80px;
      color:var(--text);
    }

    .header{
      background: var(--green);
      color:#fff;
      padding: 22px 18px;
      text-align:center;
      border-bottom-left-radius: 24px;
      border-bottom-right-radius: 24px;
    }
    .header img{
      width: 92px;
      height:auto;
      display:block;
      margin: 0 auto 10px;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }
    .header h2{margin:6px 0 2px;font-size:22px}
    .header h3{margin:0;font-weight:600;opacity:.95;font-size:15px}
    .header .docente{margin-top:8px;font-weight:800;font-size:14px;opacity:.95}
    .header .app-title{margin-top:10px;font-size:15px;font-weight:800;letter-spacing:.2px}

    .menu{
      display:flex;
      justify-content:space-between;
      gap:10px;
      background: #2a6f2f;
      padding: 10px;
      border-radius: 999px;
      width: 92%;
      margin: 16px auto;
      box-shadow: var(--shadow);
    }
    .menu button{
      flex:1;
      background:#fff;
      color: #1b5e20;
      border:none;
      padding: 14px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      font-size: 15px;
    }
    .menu button.active{
      background: #144117;
      color:#fff;
    }

    .container{
      background:var(--card);
      width: 92%;
      margin: 10px auto;
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    h3{margin:0 0 6px;font-size:18px}
    .info-text{
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
      line-height:1.35;
    }

    input, select, textarea{
      width:100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid #b7c0b9;
      font-size: 16px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus, textarea:focus{
      border-color:#1b5e20;
      box-shadow: 0 0 0 3px rgba(27,94,32,.15);
    }
    textarea{
      resize:none;
      min-height: 120px;
    }

    .btn{
      margin-top: 14px;
      width:100%;
      padding: 14px;
      background: var(--green);
      color:#fff;
      font-weight: 900;
      border-radius: 14px;
      border:none;
      cursor:pointer;
      font-size: 16px;
    }
    .btn.sec{
      background:#444;
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background:#e8f7ea;
      color:#145018;
      font-weight:800;
      font-size:13px;
      border:1px solid #bfe6c6;
      margin: 14px auto 0;
      width: 92%;
      justify-content:center;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:#16a34a;
      box-shadow:0 0 0 4px rgba(22,163,74,.18);
    }

    .card-reg{
      margin-top:12px;
      border-radius: 16px;
      border: 1px solid #d7dfd9;
      overflow:hidden;
      background:#fff;
    }
    .card-reg .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 12px 12px;
      color:#fff;
      font-weight: 900;
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.25);
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
    }
    .card-reg .body{
      padding: 12px;
      font-size: 14px;
      line-height: 1.35;
      color: #0b1f12;
      background:#fff;
    }
    .row{margin-top:8px}
    .row b{display:block;margin-bottom:2px}
    .muted{color:var(--muted)}

    .signature-container{
      margin-top: 12px;
      background:#f3f5f4;
      padding: 10px;
      border-radius: 14px;
      border:1px dashed #b7c0b9;
    }
    canvas{
      width:100%;
      height: 190px;
      background:#fff;
      border-radius: 12px;
      border: 2px solid #c9d2cb;
      touch-action: none; /* clave para firmar en celular */
      display:block;
    }
    .sig-actions{
      display:flex;
      gap:10px;
      margin-top: 10px;
      flex-wrap:wrap;
    }
    .sig-actions button{
      flex:1;
      min-width: 140px;
    }

    .footer-text{
      margin: 20px;
      font-size: 16px;
      font-weight: 900;
      color: #145018;
      text-align:center;
      line-height:1.35;
    }

    .small-note{
      margin-top: 8px;
      font-size: 13px;
      color: #334155;
      font-weight: 700;
    }

    /* placeholder/‚Äúmarca de agua‚Äù para date */
    input[type="date"]{
      position: relative;
    }
    input[type="date"]::before{
      content: attr(data-placeholder);
      color: #94a3b8;
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
    }
    input[type="date"].has-value::before{
      content: "";
    }
  </style>

  <!-- Firebase (compat, como tu portal original) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
      authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
      projectId: "diariodeprocesos-6f78d",
      storageBucket: "diariodeprocesos-6f78d.appspot.com",
      messagingSenderId: "487922338632",
      appId: "1:487922338632:web:47fc48c23dbea064b0817d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/Observacionesycontroldeausentismoescolar/sw.js")
        .catch(err => console.log("Error SW:", err));
    }
  </script>
</head>

<body>
  <div class="header">
    <img src="escudo.png" alt="Escudo I.E. De Mar√≠a" onerror="this.style.display='none'">
    <h2>Instituci√≥n Educativa de Mar√≠a</h2>
    <h3>Sede Rural Santa Juana (Primaria) ‚Äì 2026</h3>
    <div class="docente">Docente: Oscar Barrientos</div>
    <div class="app-title">Seguimiento de Procesos Escolares ¬∑ Primaria 2026</div>
  </div>

  <div class="pill"><span class="dot"></span><span>Portal del acudiente</span></div>

  <div class="menu">
    <button id="btnObs" class="active" type="button" onclick="mostrarObservaciones()">Observaciones</button>
    <button id="btnExc" type="button" onclick="mostrarExcusas()">Excusas</button>
  </div>

  <!-- OBSERVACIONES -->
  <div id="observaciones" class="container">
    <h3>Documento del estudiante</h3>
    <input type="number" id="docObs" placeholder="Ej: 15271403" inputmode="numeric">
    <div class="info-text">
      Digite el documento para consultar observaciones y firmar cada registro como recibido.
    </div>

    <button id="btnBuscarObs" class="btn" type="button" onclick="buscarObservaciones()">
      Buscar observaciones
    </button>

    <div id="resultadoObs" style="margin-top:12px;"></div>
  </div>

  <!-- EXCUSAS -->
  <div id="excusas" class="container" style="display:none;">
    <h3>Documento del estudiante</h3>
    <input type="number" id="docExc" placeholder="Ej: 15271403" inputmode="numeric">
    <div class="info-text">
      Primero digite el documento para identificarse y luego contin√∫e.
    </div>

    <button class="btn" type="button" onclick="mostrarFormularioExcusa()">Continuar</button>

    <div id="formExcusa" style="display:none; margin-top:18px;">
      <div id="nombreEstudiante" style="margin-bottom:10px; font-weight:900;"></div>

      <h3>Fecha de inasistencia</h3>
      <input type="date" id="fechaExc" data-placeholder="Fecha">

      <h3>Motivo</h3>
      <select id="motivo">
        <option value="Enfermedad">Enfermedad</option>
        <option value="Cita m√©dica">Cita m√©dica</option>
        <option value="Calamidad">Calamidad</option>
        <option value="Otro">Otro (especifique)</option>
      </select>

      <textarea id="detalleMotivo" placeholder="Detalle del motivo"></textarea>

      <h3>Firma del acudiente</h3>
      <div class="signature-container">
        <canvas id="firmaPadExc"></canvas>
        <div class="sig-actions">
          <button type="button" class="btn sec" onclick="limpiarFirmaExc()">Limpiar firma</button>
        </div>
      </div>

      <button id="btnEnviarExc" class="btn" type="button" onclick="enviarExcusa()">
        Enviar excusa
      </button>

      <div class="small-note">
        Nota: Recuerde que el estudiante debe ponerse al d√≠a con las actividades realizadas durante su ausencia.
      </div>
    </div>
  </div>

  <div class="footer-text">
    ‚ÄúFamilia y escuela caminamos juntos: al colaborar y comunicarnos, construimos el mejor camino para el bienestar y aprendizaje de nuestros hijos.‚Äù
  </div>

  <script>
    // ----- Tabs -----
    function mostrarObservaciones(){
      document.getElementById("observaciones").style.display="block";
      document.getElementById("excusas").style.display="none";
      document.getElementById("btnObs").classList.add("active");
      document.getElementById("btnExc").classList.remove("active");
    }
    function mostrarExcusas(){
      document.getElementById("observaciones").style.display="none";
      document.getElementById("excusas").style.display="block";
      document.getElementById("btnExc").classList.add("active");
      document.getElementById("btnObs").classList.remove("active");
    }

    // ----- Util -----
    function esc(s){ return String(s??"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));}

    function nivelColor(n){
      if(n>=3) return getComputedStyle(document.documentElement).getPropertyValue("--lvl3").trim();
      if(n===2) return getComputedStyle(document.documentElement).getPropertyValue("--lvl2").trim();
      return getComputedStyle(document.documentElement).getPropertyValue("--lvl1").trim();
    }
    function nivelMensaje(n){
      if(n>=3){
        return "‚ö†Ô∏è Por favor p√≥ngase en contacto con el docente para realizar una entrevista de seguimiento.";
      }
      return "‚úÖ Recuerde: si llega a presentarse una anotaci√≥n n√∫mero 3 durante el per√≠odo, como acudiente ser√° llamado para una entrevista directamente con el docente.";
    }

    // =========================
    //   FIRMA (OBSERVACIONES)
    // =========================
    const sigPads = new Map(); // idRegistro -> {canvas, ctx, drew, lastX,lastY, drawing}

    function initPad(canvas){
      const ctx = canvas.getContext("2d");
      // Ajuste real de tama√±o (clave para que el dedo pinte bien)
      function resize(){
        const rect = canvas.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        canvas.width = Math.max(1, Math.floor(rect.width * ratio));
        canvas.height = Math.max(1, Math.floor(190 * ratio));
        canvas.style.height = "190px";
        ctx.setTransform(ratio,0,0,ratio,0,0);
        ctx.lineWidth = 2.2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#0b1f12";
      }
      resize();

      let drawing=false, lastX=0, lastY=0, drew=false;

      function pos(e){
        const r = canvas.getBoundingClientRect();
        if(e.touches && e.touches[0]){
          return {x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top};
        }
        return {x: e.clientX - r.left, y: e.clientY - r.top};
      }
      function start(e){
        e.preventDefault();
        drawing=true;
        const p=pos(e);
        lastX=p.x; lastY=p.y;
      }
      function move(e){
        if(!drawing) return;
        e.preventDefault();
        const p=pos(e);
        ctx.beginPath();
        ctx.moveTo(lastX,lastY);
        ctx.lineTo(p.x,p.y);
        ctx.stroke();
        lastX=p.x; lastY=p.y;
        drew=true;
      }
      function end(e){
        e && e.preventDefault();
        drawing=false;
      }

      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", move);
      canvas.addEventListener("mouseup", end);
      canvas.addEventListener("mouseleave", end);

      canvas.addEventListener("touchstart", start, {passive:false});
      canvas.addEventListener("touchmove", move, {passive:false});
      canvas.addEventListener("touchend", end, {passive:false});
      canvas.addEventListener("touchcancel", end, {passive:false});

      window.addEventListener("resize", () => {
        // reescalar sin borrar: en firma real se acepta reiniciar si cambia orientaci√≥n
        resize();
      });

      return {
        canvas, ctx,
        hasDraw: ()=>drew,
        clear: ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); drew=false; },
        toDataURL: ()=>canvas.toDataURL("image/png")
      };
    }

    // =========================
    //   OBSERVACIONES (QUERY + FIRMA)
    // =========================
    async function buscarObservaciones(){
      const doc = document.getElementById("docObs").value.trim();
      const resDiv = document.getElementById("resultadoObs");
      const btn = document.getElementById("btnBuscarObs");

      if(!doc){
        alert("Por favor, digite el documento del estudiante.");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Buscando...";
      resDiv.innerHTML = "<em>Cargando observaciones...</em>";

      try{
        // üëá Soporta ambos esquemas:
        // - documentoEstudiante (docente)
        // - documento (portal viejo)
        const q1 = db.collection("registrosComportamentales").where("documentoEstudiante","==",doc);
        const q2 = db.collection("registrosComportamentales").where("documento","==",doc);

        const [snap1, snap2] = await Promise.all([q1.get(), q2.get()]);

        // unir sin duplicar
        const map = new Map();
        snap1.forEach(d => map.set(d.id, {id:d.id, ...d.data()}));
        snap2.forEach(d => map.set(d.id, {id:d.id, ...d.data()}));

        const items = Array.from(map.values());

        if(items.length === 0){
          resDiv.innerHTML = "<strong>No hay observaciones registradas para este documento.</strong>";
          return;
        }

        // ordenar por fecha (si existe)
        items.sort((a,b)=> String(a.fecha||"").localeCompare(String(b.fecha||"")));

        // construir HTML
        let html = `<div style="font-weight:900; margin-bottom:8px;">Observaciones encontradas: ${items.length}</div>`;

        items.forEach((r, idx) => {
          const num = idx + 1;
          const color = nivelColor(num);

          // Campos compatibles
          const fecha = r.fecha || "";
          const comportamiento = r.comportamiento || "";
          const descargos = r.descargos || "";
          const procedimiento = r.procedimiento || "";

          // Firma acudiente (compatible)
          const firmaAcudiente = r.firmaAcudiente || r.firma || ""; // por si alguien la guard√≥ con otro nombre
          const yaFirmo = !!firmaAcudiente;

          html += `
            <div class="card-reg" id="card_${r.id}">
              <div class="top" style="background:${color}">
                <div>Registro N¬∞ ${num}</div>
                <div class="badge">${yaFirmo ? "FIRMADO ‚úÖ" : "PENDIENTE ‚úçÔ∏è"}</div>
              </div>
              <div class="body">
                <div class="row"><b>Fecha:</b> <span class="muted">${esc(fecha)}</span></div>
                <div class="row"><b>Comportamiento:</b> ${esc(comportamiento)}</div>
                <div class="row"><b>Descargos:</b> ${esc(descargos)}</div>
                <div class="row"><b>Procedimiento:</b> ${esc(procedimiento)}</div>

                <div class="row" style="margin-top:10px;">
                  <b>Firma del acudiente (recibido)</b>
                  <div class="info-text">${nivelMensaje(num)}</div>

                  ${yaFirmo ? `
                    <div style="margin-top:10px;">
                      <img src="${firmaAcudiente}" alt="Firma acudiente" style="width:100%;max-width:420px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;">
                      <div class="small-note">Este registro ya fue firmado. No se puede firmar nuevamente.</div>
                    </div>
                  ` : `
                    <div class="signature-container">
                      <canvas id="sig_${r.id}"></canvas>
                      <div class="sig-actions">
                        <button type="button" class="btn sec" onclick="limpiarFirmaObs('${r.id}')">Limpiar firma</button>
                        <button type="button" class="btn" onclick="enviarFirmaAcudiente('${r.id}', ${num})">Firmar y enviar</button>
                      </div>
                    </div>
                  `}
                </div>
              </div>
            </div>
          `;
        });

        resDiv.innerHTML = html;

        // Inicializar pads SOLO para pendientes
        items.forEach((r, idx)=>{
          const firmaAcudiente = r.firmaAcudiente || r.firma || "";
          if(firmaAcudiente) return;
          const canvas = document.getElementById(`sig_${r.id}`);
          if(!canvas) return;
          const pad = initPad(canvas);
          sigPads.set(r.id, pad);
        });

      }catch(err){
        console.error(err);
        resDiv.innerHTML = "<strong>Ocurri√≥ un error al buscar las observaciones.</strong>";
        alert("Error al buscar observaciones.\n\nDetalle: " + (err?.message || err));
      }finally{
        btn.disabled = false;
        btn.textContent = "Buscar observaciones";
      }
    }

    function limpiarFirmaObs(id){
      const pad = sigPads.get(id);
      if(pad) pad.clear();
    }

    async function enviarFirmaAcudiente(idDoc, numeroRegistro){
      const pad = sigPads.get(idDoc);
      if(!pad){
        alert("No se encontr√≥ el espacio de firma. Recargue la p√°gina e intente nuevamente.");
        return;
      }
      if(!pad.hasDraw()){
        alert("Por favor firme antes de enviar.");
        return;
      }

      const img = pad.toDataURL();

      try{
        // Guardar firma en el documento correcto
        await db.collection("registrosComportamentales").doc(idDoc).update({
          firmaAcudiente: img,
          fechaFirmaAcudiente: new Date().toISOString()
        });

        // Mensajes seg√∫n nivel
        if(numeroRegistro >= 3){
          alert("‚úÖ Firma registrada.\n\n‚ö†Ô∏è Importante: Por favor p√≥ngase en contacto con el docente para realizar una entrevista de seguimiento.");
        }else{
          alert("‚úÖ Firma registrada.\n\nRecuerde: si llega a presentarse una anotaci√≥n n√∫mero 3, como acudiente ser√° llamado para una entrevista directamente con el docente.");
        }

        // Recargar resultados para bloquear firma
        buscarObservaciones();

      }catch(err){
        console.error(err);
        alert("‚ùå No se pudo guardar la firma.\n\nDetalle: " + (err?.message || err));
      }
    }

    // =========================
    //   EXCUSAS (PASO 1 -> FORM)
    // =========================
    const canvasExc = document.getElementById("firmaPadExc");
    const ctxExc = canvasExc.getContext("2d");
let excPad = null;

    function initPadExc(){
      excPad = initPad(canvasExc);
    }
    function limpiarFirmaExc(){
      if(excPad) excPad.clear();
    }

    // placeholder date
    const fechaExc = document.getElementById("fechaExc");
    function syncDatePlaceholder(){
      if(fechaExc.value) fechaExc.classList.add("has-value");
      else fechaExc.classList.remove("has-value");
    }
    fechaExc.addEventListener("change", syncDatePlaceholder);
    syncDatePlaceholder();

    async function mostrarFormularioExcusa(){
      const doc = document.getElementById("docExc").value.trim();
      const nombreDiv = document.getElementById("nombreEstudiante");
      const form = document.getElementById("formExcusa");

      if(!doc){
        alert("Por favor, digite el documento del estudiante.");
        return;
      }

      form.style.display = "block";
      nombreDiv.textContent = "Estudiante: (verificando...)";

      try{
        // Buscar nombre desde registros (compat: documentoEstudiante o documento)
        const q1 = db.collection("registrosComportamentales").where("documentoEstudiante","==",doc).limit(1);
        const q2 = db.collection("registrosComportamentales").where("documento","==",doc).limit(1);
        const [s1,s2] = await Promise.all([q1.get(), q2.get()]);
        let datos = null;

        if(!s1.empty) datos = s1.docs[0].data();
        else if(!s2.empty) datos = s2.docs[0].data();

        if(datos){
          nombreDiv.textContent = "Estudiante: " + (datos.nombreEstudiante || "(sin nombre registrado)");
        }else{
          nombreDiv.textContent = "Estudiante: (no encontrado en registros, pero puede enviar la excusa)";
        }
      }catch(err){
        console.error(err);
        nombreDiv.textContent = "Estudiante: (no se pudo verificar el nombre, pero puede enviar la excusa)";
      }

      // Inicializar firma cuando ya est√° visible
      setTimeout(()=> {
        initPadExc();
      }, 50);
    }

    async function enviarExcusa(){
      const doc = document.getElementById("docExc").value.trim();
      const fecha = document.getElementById("fechaExc").value;
      const motivo = document.getElementById("motivo").value;
      const detalle = document.getElementById("detalleMotivo").value.trim();
      const btn = document.getElementById("btnEnviarExc");

      if(!doc || !fecha || !motivo || !detalle){
        alert("Por favor, complete todos los campos de la excusa.");
        return;
      }
      if(!excPad || !excPad.hasDraw()){
        alert("Por favor firme antes de enviar la excusa.");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Enviando...";

      try{
        await db.collection("excusasInasistencia").add({
          documentoEstudiante: doc,  // ‚úÖ coincide con el docente
          fechaInasistencia: fecha,  // ‚úÖ coincide con el docente
          motivoTipo: motivo,
          motivoDetalle: detalle,
          firmaAcudiente: excPad.toDataURL(),
          fechaEnvio: new Date().toISOString()
        });

        alert(
          "‚úÖ Excusa enviada correctamente.\n\n" +
          "Recuerde que es obligaci√≥n del estudiante ponerse al d√≠a con las actividades delegadas durante su ausencia."
        );

        // Limpiar
        document.getElementById("fechaExc").value = "";
        syncDatePlaceholder();
        document.getElementById("motivo").value = "Enfermedad";
        document.getElementById("detalleMotivo").value = "";
        limpiarFirmaExc();

      }catch(err){
        console.error(err);
        alert("‚ùå Ocurri√≥ un error al enviar la excusa.\n\nDetalle: " + (err?.message || err));
      }finally{
        btn.disabled = false;
        btn.textContent = "Enviar excusa";
      }
    }
  </script>
</body>
</html>
