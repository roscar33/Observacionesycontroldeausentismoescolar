<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Seguimiento de Procesos Escolares · Primaria 2026</title>
<meta name="theme-color" content="#1b5e20" />

<style>
  body { margin: 0; font-family: system-ui, Arial, sans-serif; background: #dff5e1; padding-bottom: 95px; }
  .header { background: #1b5e20; color: #fff; text-align: center; padding: 20px 16px; border-radius: 0 0 25px 25px; }
  
  /* Ajuste para que la imagen se vea centrada y bonita */
  .header img { width: 90px; height: auto; margin-bottom: 10px; display: inline-block; }
  
  .menu { display: flex; justify-content: space-around; gap: 10px; background: #2e7d32; padding: 10px; margin: 16px auto; width: 92%; border-radius: 999px; }
  .menu button { flex: 1; border: none; padding: 12px 14px; border-radius: 999px; font-weight: 900; cursor: pointer; background: #fff; color: #1b5e20; }
  .menu button.active { background: #1b5e20; color: #fff; }
  .container { background: #fff; width: 92%; margin: 10px auto; padding: 16px; border-radius: 18px; box-shadow: 0 6px 14px rgba(0, 0, 0, .18); }
  input, textarea, select { width: 100%; padding: 12px; margin-top: 10px; border-radius: 12px; border: 1px solid #aaa; font-size: 15px; box-sizing: border-box; }
  textarea { min-height: 110px; resize: none; }
  .btn { width: 100%; padding: 14px; margin-top: 15px; background: #1b5e20; color: #fff; font-weight: 900; border: none; border-radius: 14px; cursor: pointer; }
  .btn.sec { background: #444; }
  .btn:disabled { opacity: .6; cursor: not-allowed; }
  .info { margin-top: 8px; color: #4b5563; font-size: 14px; line-height: 1.35; }
  .card { margin-top: 14px; border-radius: 16px; overflow: hidden; border: 1px solid #ddd; background: #fff; }
  .card .top { padding: 10px 12px; font-weight: 900; color: #fff; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
  .badge { padding: 6px 10px; border-radius: 999px; background: rgba(255, 255, 255, .18); border: 1px solid rgba(255, 255, 255, .25); font-size: 12px; font-weight: 900; white-space: nowrap; }
  .card .body { padding: 12px; color: #0b1f12; font-size: 14px; line-height: 1.35; }
  .row { margin-top: 10px; }
  .row b { display: block; margin-bottom: 4px; }
  .muted { color: #64748b; }
  .sig-wrap { margin-top: 10px; padding: 10px; border-radius: 14px; background: #f3f5f4; border: 1px dashed #b7c0b9; }
  canvas { width: 100%; height: 190px; border: 2px solid #999; border-radius: 12px; background: #fff; touch-action: none; display: block; }
  .sig-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
  .sig-actions button { flex: 1; min-width: 140px; }
  .footer { margin: 28px 18px 10px; text-align: center; font-size: 14px; font-weight: 650; color: #145018; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
  firebase.initializeApp({
    apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
    authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
    projectId: "diariodeprocesos-6f78d"
  });
  const db = firebase.firestore();
</script>
</head>

<body>
  <div class="header">
    <!-- 
      NOTA: El atributo 'onerror' es solo para esta vista previa. 
      Cuando pongas este código en GitHub junto con tu archivo 'escudo.png', 
      se verá tu imagen real. 
    -->
    <img 
      src="escudo.png" 
      alt="Escudo I.E. De María" 
      onerror="this.onerror=null; this.src='https://placehold.co/100x100/1b5e20/ffffff?text=Escudo+IE';"
    >
    <h2>Institución Educativa de María</h2>
    <h4>Sede Rural Santa Juana · Primaria 2026</h4>
    <strong>Docente: Oscar Barrientos</strong>
    <p>Seguimiento de Procesos Escolares</p>
  </div>

  <div class="menu">
    <button id="btnObs" class="active" type="button" onclick="verObs()">Observaciones</button>
    <button id="btnExc" type="button" onclick="verExc()">Excusas</button>
  </div>

  <!-- OBSERVACIONES -->
  <div id="obs" class="container">
    <h3 style="margin:0 0 6px;">Documento del estudiante</h3>
    <input id="docObs" type="number" placeholder="Digite documento del estudiante" inputmode="numeric">
    <div class="info">Digite el documento para consultar observaciones y firmar cada registro como recibido.</div>
    <button id="btnBuscar" class="btn" type="button" onclick="buscarObservaciones()">Buscar observaciones</button>
    <div id="resultadoObs" style="margin-top:12px;"></div>
  </div>

  <!-- EXCUSAS -->
  <div id="exc" class="container" style="display:none;">
    <h3 style="margin:0 0 6px;">Documento del estudiante</h3>
    <input id="docExc" type="number" placeholder="Documento del estudiante" inputmode="numeric">
    <div class="info">Primero digite el documento. Luego se habilita el formulario.</div>
    <button class="btn" type="button" onclick="mostrarFormularioExc()">Continuar</button>

    <div id="formExc" style="display:none; margin-top:16px;">
      <div id="nombreExc" style="font-weight:900; margin-bottom:6px;"></div>

      <h3 style="margin:10px 0 6px;">Fecha de inasistencia</h3>
      <input id="fechaExc" type="date">

      <h3 style="margin:10px 0 6px;">Motivo</h3>
      <select id="motivoExc">
        <option value="Enfermedad">Enfermedad</option>
        <option value="Cita médica">Cita médica</option>
        <option value="Calamidad">Calamidad</option>
        <option value="Otro">Otro</option>
      </select>

      <textarea id="detalleExc" placeholder="Detalle del motivo"></textarea>

      <h3 style="margin:10px 0 6px;">Firma del acudiente</h3>
      <div class="sig-wrap">
        <canvas id="sigExc"></canvas>
        <div class="sig-actions">
          <button class="btn sec" type="button" onclick="limpiarPad('sigExc')">Limpiar firma</button>
        </div>
      </div>

      <button id="btnEnviarExc" class="btn" type="button" onclick="enviarExcusa()">Enviar excusa</button>
      <div class="info" style="margin-top:10px;">
        Nota: el estudiante debe ponerse al día con las actividades realizadas durante su ausencia.
      </div>
    </div>
  </div>

  <div class="footer">
    “Familia y escuela caminamos juntos: al colaborar y comunicarnos,
    construimos el mejor camino para el bienestar y aprendizaje de nuestros hijos.”
  </div>

<script>
  // Tabs
  function verObs(){
    document.getElementById("obs").style.display="block";
    document.getElementById("exc").style.display="none";
    document.getElementById("btnObs").classList.add("active");
    document.getElementById("btnExc").classList.remove("active");
  }
  function verExc(){
    document.getElementById("obs").style.display="none";
    document.getElementById("exc").style.display="block";
    document.getElementById("btnExc").classList.add("active");
    document.getElementById("btnObs").classList.remove("active");
  }

  // Helpers
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function colorRegistro(n){ return n===1 ? "#16a34a" : (n===2 ? "#f59e0b" : "#dc2626"); }
  function mensajeRegistro(n){
    if(n>=3) return "⚠️ Por favor póngase en contacto con el docente para realizar una entrevista de seguimiento.";
    return "✅ Recuerde: si llega a presentarse una anotación número 3, como acudiente será llamado para una entrevista directamente con el docente.";
  }

  // Signature pads
  const pads = new Map(); // canvasId -> {ctx, drew, clear, toDataURL}
  function initPad(canvasId){
    const c = document.getElementById(canvasId);
    if(!c) return;

    const ctx = c.getContext("2d");
    let drawing=false, lastX=0, lastY=0, drew=false;

    function getPos(e){
      const r = c.getBoundingClientRect();
      if(e.touches && e.touches[0]){
        return {x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top};
      }
      return {x: (e.clientX - r.left), y: (e.clientY - r.top)};
    }

    function start(e){
      e.preventDefault();
      drawing=true;
      const p=getPos(e);
      lastX=p.x; lastY=p.y;
    }
    function move(e){
      if(!drawing) return;
      e.preventDefault();
      const p=getPos(e);
      ctx.strokeStyle="#0b1f12";
      ctx.lineWidth=2.3;
      ctx.lineCap="round";
      ctx.beginPath();
      ctx.moveTo(lastX,lastY);
      ctx.lineTo(p.x,p.y);
      ctx.stroke();
      lastX=p.x; lastY=p.y;
      drew=true;
    }
    function end(e){
      e && e.preventDefault();
      drawing=false;
    }

    // Mouse
    c.addEventListener("mousedown", start);
    c.addEventListener("mousemove", move);
    c.addEventListener("mouseup", end);
    c.addEventListener("mouseleave", end);

    // Touch
    c.addEventListener("touchstart", start, {passive:false});
    c.addEventListener("touchmove", move, {passive:false});
    c.addEventListener("touchend", end, {passive:false});
    c.addEventListener("touchcancel", end, {passive:false});

    pads.set(canvasId, {
      hasDraw: ()=>drew,
      clear: ()=>{ ctx.clearRect(0,0,c.width,c.height); drew=false; },
      toDataURL: ()=>c.toDataURL("image/png")
    });

    function resize(){
      const rect = c.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      c.width = Math.max(1, Math.floor(rect.width * ratio));
      c.height = Math.max(1, Math.floor(190 * ratio));
      ctx.setTransform(ratio,0,0,ratio,0,0);
    }
    resize();
    window.addEventListener("resize", resize);
  }

  function limpiarPad(canvasId){
    const p = pads.get(canvasId);
    if(p) p.clear();
  }

  // OBSERVACIONES
  async function buscarObservaciones(){
    const doc = document.getElementById("docObs").value.trim();
    const out = document.getElementById("resultadoObs");
    const btn = document.getElementById("btnBuscar");

    if(!doc){ alert("Por favor, digite el documento del estudiante."); return; }

    btn.disabled = true;
    btn.textContent = "Buscando...";
    out.innerHTML = "<em>Cargando observaciones...</em>";

    try{
      const q1 = db.collection("registrosComportamentales").where("documentoEstudiante","==",doc);
      const q2 = db.collection("registrosComportamentales").where("documento","==",doc);

      const [s1, s2] = await Promise.all([q1.get(), q2.get()]);

      const map = new Map();
      // CORRECCIÓN ID: Usar ID real de Firestore
      s1.forEach(d => map.set(d.id, { ...d.data(), id: d.id }));
      s2.forEach(d => map.set(d.id, { ...d.data(), id: d.id }));

      const items = Array.from(map.values());
      if(items.length === 0){
        out.innerHTML = "<strong>No hay observaciones registradas para este documento.</strong>";
        return;
      }

      items.sort((a,b)=> String(a.fecha||"").localeCompare(String(b.fecha||"")));

      let html = `<div style="font-weight:900;margin-bottom:8px;">Observaciones encontradas: ${items.length}</div>`;

      items.forEach((r, idx)=>{
        const n = idx + 1;
        const color = colorRegistro(n);

        const fecha = r.fecha || "";
        const comportamiento = r.comportamiento || "";
        const descargos = r.descargos || "";
        const procedimiento = r.procedimiento || "";

        const firmaAcudiente = r.firmaAcudiente || "";
        const yaFirmo = !!firmaAcudiente;

        html += `
          <div class="card">
            <div class="top" style="background:${color}">
              <div>Registro N° ${n}</div>
              <div class="badge">${yaFirmo ? "FIRMADO ✅" : "PENDIENTE ✍️"}</div>
            </div>

            <div class="body">
              <div class="row"><b>Fecha:</b> <span class="muted">${esc(fecha)}</span></div>
              <div class="row"><b>Comportamiento:</b> ${esc(comportamiento)}</div>
              <div class="row"><b>Descargos:</b> ${esc(descargos)}</div>
              <div class="row"><b>Procedimiento:</b> ${esc(procedimiento)}</div>

              <div class="row">
                <b>Firma del acudiente (recibido)</b>
                <div class="info">${mensajeRegistro(n)}</div>

                ${yaFirmo ? `
                  <div style="margin-top:10px;">
                    <img src="${firmaAcudiente}" alt="Firma acudiente" style="width:100%;max-width:420px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;">
                    <div class="info">Este registro ya fue firmado. No se puede firmar nuevamente.</div>
                  </div>
                ` : `
                  <div class="sig-wrap">
                    <canvas id="sig_${r.id}"></canvas>
                    <div class="sig-actions">
                      <button class="btn sec" type="button" onclick="limpiarPad('sig_${r.id}')">Limpiar firma</button>
                      <button class="btn" type="button" onclick="firmarRegistro('${r.id}', ${n})">Firmar y enviar</button>
                    </div>
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      });

      out.innerHTML = html;

      items.forEach(r=>{
        if(r.firmaAcudiente) return;
        initPad(`sig_${r.id}`);
      });

    }catch(err){
      console.error(err);
      out.innerHTML = "<strong>Ocurrió un error al buscar las observaciones.</strong>";
      alert("Error al buscar observaciones.\n\nDetalle: " + (err?.message || err));
    }finally{
      btn.disabled = false;
      btn.textContent = "Buscar observaciones";
    }
  }

  async function firmarRegistro(docId, numRegistro){
    const canvasId = `sig_${docId}`;
    const pad = pads.get(canvasId);
    if(!pad){
      alert("No se encontró el espacio de firma. Recargue e intente nuevamente.");
      return;
    }
    if(!pad.hasDraw()){
      alert("Por favor firme antes de enviar.");
      return;
    }

    try{
      await db.collection("registrosComportamentales").doc(docId).update({
        firmaAcudiente: pad.toDataURL(),
        fechaFirmaAcudiente: new Date().toISOString()
      });

      if(numRegistro >= 3){
        alert("✅ Firma registrada.\n\n⚠️ Importante: Por favor póngase en contacto con el docente para realizar una entrevista de seguimiento.");
      } else {
        alert("✅ Firma registrada.\n\nRecuerde: si llega a presentarse una anotación número 3, como acudiente será llamado para una entrevista directamente con el docente.");
      }

      buscarObservaciones();
    }catch(err){
      console.error(err);
      alert("❌ No se pudo guardar la firma.\n\nDetalle: " + (err?.message || err));
    }
  }

  // EXCUSAS
  async function mostrarFormularioExc(){
    const doc = document.getElementById("docExc").value.trim();
    const form = document.getElementById("formExc");
    const nombreDiv = document.getElementById("nombreExc");

    if(!doc){ alert("Por favor, digite el documento del estudiante."); return; }

    form.style.display = "block";
    nombreDiv.textContent = "Estudiante: (verificando...)";

    try{
      const q1 = db.collection("registrosComportamentales").where("documentoEstudiante","==",doc).limit(1);
      const q2 = db.collection("registrosComportamentales").where("documento","==",doc).limit(1);
      const [s1, s2] = await Promise.all([q1.get(), q2.get()]);

      let datos = null;
      if(!s1.empty) datos = s1.docs[0].data();
      else if(!s2.empty) datos = s2.docs[0].data();

      nombreDiv.textContent = "Estudiante: " + (datos?.nombreEstudiante || "(sin nombre registrado)");
    }catch(e){
      console.error(e);
      nombreDiv.textContent = "Estudiante: (no se pudo verificar, pero puede enviar la excusa)";
    }

    setTimeout(()=>initPad("sigExc"), 50);
  }

  async function enviarExcusa(){
    const doc = document.getElementById("docExc").value.trim();
    const fecha = document.getElementById("fechaExc").value;
    const motivo = document.getElementById("motivoExc").value;
    const detalle = document.getElementById("detalleExc").value.trim();
    const btn = document.getElementById("btnEnviarExc");
    const pad = pads.get("sigExc");

    if(!doc || !fecha || !motivo || !detalle){
      alert("Complete todos los campos de la excusa.");
      return;
    }
    if(!pad || !pad.hasDraw()){
      alert("Por favor firme antes de enviar la excusa.");
      return;
    }

    btn.disabled = true;
    btn.textContent = "Enviando...";

    try{
      await db.collection("excusasInasistencia").add({
        documentoEstudiante: doc,
        fechaInasistencia: fecha,
        motivoTipo: motivo,
        motivoDetalle: detalle,
        firmaAcudiente: pad.toDataURL(),
        fechaEnvio: new Date().toISOString()
      });

      alert("✅ Excusa enviada correctamente.");

      document.getElementById("fechaExc").value = "";
      document.getElementById("motivoExc").value = "Enfermedad";
      document.getElementById("detalleExc").value = "";
      limpiarPad("sigExc");
    }catch(err){
      console.error(err);
      alert("❌ Error al enviar la excusa.\n\nDetalle: " + (err?.message || err));
    }finally{
      btn.disabled = false;
      btn.textContent = "Enviar excusa";
    }
  }
</script>
</body>
</html>


