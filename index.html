<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Portal del Acudiente - I.E. De María</title>

    <!-- Manifest para PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1b5e20">

    <!-- Estilos generales -->
    <style>
        body {
            margin: 0;
            background: #dff5e1;
            font-family: Arial, sans-serif;
            padding-bottom: 80px;
        }

        .header {
            background: #1b5e20;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        .header img {
            width: 90px;
            margin-bottom: 10px;
        }

        .menu {
            display: flex;
            justify-content: space-around;
            background: #2e7d32;
            padding: 10px;
            border-radius: 30px;
            width: 90%;
            margin: 20px auto;
        }

        .menu button {
            background: white;
            color: #2e7d32;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .menu button.active {
            background: #1b5e20;
            color: white;
        }

        .container {
            background: white;
            width: 90%;
            margin: 10px auto;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 10px;
            border: 1px solid #aaa;
        }

        textarea {
            resize: none;
            height: 120px;
        }

        .btn {
            margin-top: 15px;
            width: 100%;
            padding: 15px;
            background: #1b5e20;
            color: white;
            font-weight: bold;
            border-radius: 10px;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            background: #145018;
        }

        .signature-container {
            margin-top: 15px;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 10px;
        }

        canvas {
            width: 100%;
            height: 200px;
            background: white;
            border-radius: 10px;
            border: 2px solid #ccc;
        }

        .footer-text {
            margin: 20px;
            font-size: 16px;
            font-weight: bold;
            color: #145018;
            text-align: center;
        }
    </style>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
            authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
            projectId: "diariodeprocesos-6f78d",
            storageBucket: "diariodeprocesos-6f78d.appspot.com",
            messagingSenderId: "487922338632",
            appId: "1:487922338632:web:47fc48c23dbea064b0817d"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <!-- SERVICE WORKER -->
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("sw.js")
                .catch(err => console.log("Error SW:", err));
        }
    </script>
</head>

<body>

    <!-- ENCABEZADO -->
    <div class="header">
        <img src="escudo.png">
        <h2>Institución Educativa de María</h2>
        <h3>Sede Rural Santa Juana (Primaria) – 2026</h3>
        <strong>Docente: Oscar Barrientos</strong>
    </div>

    <!-- MENÚ -->
    <div class="menu">
        <button id="btnObs" class="active" onclick="mostrarObservaciones()">Consultar observaciones</button>
        <button id="btnExc" onclick="mostrarExcusas()">Enviar excusa</button>
    </div>

    <!-- CONSULTAR OBSERVACIONES -->
    <div id="observaciones" class="container">

        <h3>Documento del estudiante</h3>
        <input type="number" id="docObs" placeholder="Ej: 15271403">

        <button class="btn" onclick="buscarObservaciones()">Buscar observaciones</button>

        <div id="resultadoObs"></div>
    </div>

    <!-- ENVIAR EXCUSA -->
    <div id="excusas" class="container" style="display:none;">

        <h3>Documento del estudiante</h3>
        <input type="number" id="docExc" placeholder="Ej: 15271403" oninput="cargarNombre()">

        <div id="nombreEstudiante" style="margin-top:10px; font-weight:bold;"></div>

        <h3>Fecha de inasistencia</h3>
        <input type="date" id="fechaExc">

        <h3>Motivo</h3>
        <select id="motivo">
            <option value="Enfermedad">Enfermedad</option>
            <option value="Cita médica">Cita médica</option>
            <option value="Calamidad">Calamidad</option>
            <option value="Otro">Otro (especifique)</option>
        </select>

        <textarea id="detalleMotivo" placeholder="Explique la razón de la inasistencia"></textarea>

        <h3>Firma del acudiente</h3>
        <div class="signature-container">
            <canvas id="firmaPad"></canvas>
            <button class="btn" style="background:#444;" onclick="limpiarFirma()">Limpiar firma</button>
        </div>

        <button class="btn" onclick="enviarExcusa()">Enviar excusa</button>
    </div>

    <div class="footer-text">
        “Familia y escuela caminamos juntos: al colaborar y comunicarnos, construimos el mejor camino para el bienestar y aprendizaje de nuestros hijos.”
    </div>

    <!-- LÓGICA DEL SISTEMA -->
    <script>
        function mostrarObservaciones() {
            document.getElementById("observaciones").style.display = "block";
            document.getElementById("excusas").style.display = "none";
            document.getElementById("btnObs").classList.add("active");
            document.getElementById("btnExc").classList.remove("active");
        }

        function mostrarExcusas() {
            document.getElementById("observaciones").style.display = "none";
            document.getElementById("excusas").style.display = "block";
            document.getElementById("btnExc").classList.add("active");
            document.getElementById("btnObs").classList.remove("active");
        }

        // CANVAS FIRMA
        const canvas = document.getElementById("firmaPad");
        const ctx = canvas.getContext("2d");
        let dibujando = false;

        canvas.width = canvas.offsetWidth;
        canvas.height = 200;

        canvas.addEventListener("mousedown", e => {
            dibujando = true;
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener("mousemove", e => {
            if (!dibujando) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        });

        canvas.addEventListener("mouseup", () => dibujando = false);
        canvas.addEventListener("mouseout", () => dibujando = false);

        function limpiarFirma() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // BUSCAR OBSERVACIONES
        async function buscarObservaciones() {
            const doc = document.getElementById("docObs").value;

            if (doc.trim() === "") {
                alert("Digite el documento");
                return;
            }

            const resDiv = document.getElementById("resultadoObs");
            resDiv.innerHTML = "<em>Cargando...</em>";

            const snap = await db.collection("registrosComportamentales")
                                 .where("documento", "==", doc)
                                 .get();

            if (snap.empty) {
                resDiv.innerHTML = "<strong>No hay observaciones registradas.</strong>";
                return;
            }

            let html = "";
            snap.forEach(doc => {
                const d = doc.data();
                html += `
                <div style="border-bottom:1px solid #ccc; padding:10px;">
                    <strong>Fecha:</strong> ${d.fecha}<br>
                    <strong>Comportamiento:</strong> ${d.comportamiento}<br>
                    <strong>Descargos:</strong> ${d.descargos}<br>
                    <strong>Procedimiento:</strong> ${d.procedimiento}<br>
                    <strong>Firma acudiente:</strong> ${d.firmaAcudiente ? "Registrada" : "Pendiente"}
                </div>`;
            });

            resDiv.innerHTML = html;
        }

        // MOSTRAR NOMBRE
        async function cargarNombre() {
            const doc = document.getElementById("docExc").value;

            if (doc.trim() === "") return;

            const snap = await db.collection("registrosComportamentales")
                                 .where("documento", "==", doc)
                                 .limit(1)
                                 .get();

            if (!snap.empty) {
                document.getElementById("nombreEstudiante").innerHTML =
                    "Estudiante: " + snap.docs[0].data().nombreEstudiante;
            }
        }

        // ENVIAR EXCUSA
        async function enviarExcusa() {
            const doc = document.getElementById("docExc").value;
            const fecha = document.getElementById("fechaExc").value;
            const motivo = document.getElementById("motivo").value;
            const detalle = document.getElementById("detalleMotivo").value;

            if (!doc || !fecha || !motivo || !detalle) {
                alert("Complete todos los campos");
                return;
            }

            const firmaImg = canvas.toDataURL();

            await db.collection("excusas").add({
                documento: doc,
                fecha,
                motivo,
                detalle,
                firma: firmaImg,
                fechaRegistro: new Date()
            });

            alert("Excusa enviada.\n\nRecuerde que es obligación del estudiante ponerse al día con las actividades delegadas durante su ausencia.");

            limpiarFirma();
            document.getElementById("fechaExc").value = "";
            document.getElementById("detalleMotivo").value = "";
        }
    </script>

</body>
</html>
