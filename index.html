<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Portal del acudiente - I.E. de María</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --primary: #16a34a;       /* un poco más oscuro que el del docente */
      --primary-dark: #15803d;
      --accent: #0ea5e9;
      --bg: #d9f99d;
      --card-bg: #ffffff;
      --border: #cbd5e1;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 30px rgba(15,23,42,0.12);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #86efac, #f9fafb 55%);
      min-height: 100vh;
      padding: 16px;
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 1100px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #16a34a55;
      background: white;
      flex-shrink: 0;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 700;
      color: #064e3b;
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .brand-meta {
      font-size: 11px;
      color: #0f172a;
      font-weight: 500;
    }

    .connection-status {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .connection-status.online {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #4ade80;
    }

    .connection-status.offline {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    @media (max-width: 900px) {
      body { padding: 10px; }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-soft);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #064e3b;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .tabs {
      display: inline-flex;
      border-radius: 999px;
      padding: 3px;
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      margin-bottom: 12px;
      gap: 3px;
    }

    .tab-button {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      color: #166534;
      transition: background 0.12s ease, color 0.12s ease, box-shadow 0.12s ease;
      white-space: nowrap;
    }

    .tab-button.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #ecfdf5;
      box-shadow: 0 8px 18px rgba(22,163,74,0.35);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
    }

    label {
      font-size: 13px;
      font-weight: 500;
      color: #0f172a;
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      background: #f9fafb;
      font-size: 13px;
      color: var(--text-main);
      outline: none;
      transition: border 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: #94a3b8;
    }

    input:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(22,163,74,0.35);
      background: #ffffff;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      border: none;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      padding: 8px 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      white-space: nowrap;
    }

    button:active { transform: scale(0.97); }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #ecfdf5;
      box-shadow: 0 10px 20px rgba(22,163,74,0.35);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #0ea5e9, #0369a1);
      color: #e0f2fe;
      box-shadow: 0 10px 20px rgba(56,189,248,0.35);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color: #fee2e2;
      box-shadow: 0 10px 20px rgba(248,113,113,0.35);
    }

    .btn-disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .records-list {
      margin-top: 10px;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #ffffff;
    }

    .records-list::-webkit-scrollbar { width: 6px; }
    .records-list::-webkit-scrollbar-track { background: #ffffff; }
    .records-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 999px;
    }

    .obs-card {
      border-radius: var(--radius-md);
      border: 1px solid #e2e8f0;
      background: #f9fafb;
      padding: 10px;
      margin-bottom: 8px;
    }

    .obs-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 12px;
      color: #0f172a;
      font-weight: 500;
    }

    .obs-body {
      font-size: 12px;
      color: #0f172a;
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 4px;
    }

    .obs-label {
      font-weight: 600;
      color: #022c22;
    }

    .badge-pendiente,
    .badge-firmado {
      display: inline-flex;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-pendiente {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .badge-firmado {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #4ade80;
    }

    .signature-panel {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px dashed #cbd5e1;
      display: none;
    }

    canvas.signature-pad {
      border-radius: 14px;
      border: 1px dashed #cbd5e1;
      background: #ffffff;
      width: 100%;
      height: 220px;
      display: block;
      cursor: crosshair;
      margin-top: 6px;
      touch-action: none;
    }

    .info-text {
      font-size: 11px;
      color: var(--text-muted);
    }

    .motivo-group {
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      background: #f9fafb;
      padding: 10px;
      margin-bottom: 10px;
    }

    .motivo-opcion {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .motivo-opcion textarea {
      margin-top: 4px;
      font-size: 12px;
      min-height: 50px;
    }

    .quote-banner {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 16px;
      background: linear-gradient(135deg,#16a34a,#15803d);
      color: #ecfdf5;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 10px 25px rgba(22,163,74,0.4);
    }

    @media (max-width: 600px) {
      body { padding: 10px; }
      .card { padding: 16px 14px 14px; }
      canvas.signature-pad { height: 200px; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- ENCABEZADO -->
    <header class="top-bar">
      <div class="brand">
        <div class="brand-logo">
          <img src="escudo.png" alt="Escudo Institución Educativa de María">
        </div>
        <div class="brand-text">
          <div class="brand-title">Institución Educativa de María</div>
          <div class="brand-subtitle">Sede Rural Santa Juana (Primaria) · 2026</div>
          <div class="brand-meta">Docente: Oscar Barrientos</div>
        </div>
      </div>
      <div id="connStatus" class="connection-status offline">
        <span class="connection-dot"></span><span>Offline</span>
      </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <section class="card">
      <div class="card-title">Portal del acudiente</div>
      <div class="card-subtitle">
        Consulte las observaciones registradas para su hijo(a) y envíe excusas por inasistencia
        de forma rápida y segura.
      </div>

      <!-- Menú / Tabs -->
      <div class="tabs">
        <button class="tab-button active" data-tab="observaciones">Consultar observaciones</button>
        <button class="tab-button" data-tab="excusa">Enviar excusa por inasistencia</button>
      </div>

      <!-- TAB: OBSERVACIONES -->
      <div id="tab-observaciones" class="tab-content active">
        <form id="formBuscarObs">
          <div class="form-group">
            <label for="docObs">Documento del estudiante</label>
            <input type="text" id="docObs" required placeholder="Ej: 123456789" />
            <div class="field-hint">Digite el número de documento del estudiante para ver las observaciones registradas.</div>
          </div>
          <div class="button-row">
            <button type="submit" class="btn-primary">Buscar observaciones</button>
          </div>
        </form>

        <div id="observacionesResumen" class="info-text" style="margin-top:10px;"></div>
        <div id="listaObservaciones" class="records-list"></div>

        <!-- Panel para firma del acudiente -->
        <div id="panelFirmaObs" class="signature-panel">
          <div class="form-group">
            <label>Firma del acudiente</label>
            <div class="field-hint">
              Seleccione primero "Firmar esta anotación" en la observación que desea firmar.
              Luego dibuje su firma aquí y presione "Enviar firma".
            </div>
          </div>
          <div class="info-text" id="firmaInfo">Ninguna observación seleccionada.</div>
          <canvas id="signaturePadAcudiente" class="signature-pad"></canvas>
          <div class="button-row">
            <button type="button" class="btn-danger" id="btnLimpiarFirmaAcudiente">Limpiar firma</button>
            <button type="button" class="btn-primary btn-disabled" id="btnEnviarFirmaAcudiente" disabled>Enviar firma</button>
          </div>
        </div>
      </div>

      <!-- TAB: EXCUSA -->
      <div id="tab-excusa" class="tab-content">
        <!-- Paso 1: documento -->
        <form id="formIdentExcusa">
          <div class="form-group">
            <label for="docExcusa">Documento del estudiante</label>
            <input type="text" id="docExcusa" required placeholder="Ej: 123456789" />
            <div class="field-hint">Digite el documento del estudiante y pulse “Continuar”.</div>
          </div>
          <div class="button-row">
            <button type="submit" class="btn-primary">Continuar</button>
          </div>
        </form>

        <div id="excusaResumen" class="info-text" style="margin-top:8px;"></div>

        <!-- Paso 2: formulario excusa -->
        <form id="formExcusa" style="display:none; margin-top:10px;">
          <div class="form-group">
            <label for="fechaInasistencia">Fecha de la inasistencia</label>
            <input type="date" id="fechaInasistencia" required />
          </div>

          <div class="form-group">
            <label>Motivo de la inasistencia</label>
            <div class="field-hint">
              Escoja una opción y explique brevemente la situación en el cuadro de texto.
              <strong>Todos los motivos requieren explicación escrita.</strong>
            </div>
          </div>

          <div class="motivo-group">
            <div class="motivo-opcion">
              <input type="radio" name="motivoTipo" id="motivoEnfermedad" value="Enfermedad" />
              <div>
                <label for="motivoEnfermedad"><strong>Enfermedad</strong></label>
                <textarea id="motivoEnfermedadTexto" placeholder="Especifique aquí la razón de la inasistencia (enfermedad)..."></textarea>
              </div>
            </div>

            <div class="motivo-opcion">
              <input type="radio" name="motivoTipo" id="motivoCita" value="Cita médica" />
              <div>
                <label for="motivoCita"><strong>Cita médica</strong></label>
                <textarea id="motivoCitaTexto" placeholder="Especifique aquí la razón de la inasistencia (cita médica)..."></textarea>
              </div>
            </div>

            <div class="motivo-opcion">
              <input type="radio" name="motivoTipo" id="motivoCalamidad" value="Calamidad" />
              <div>
                <label for="motivoCalamidad"><strong>Calamidad</strong></label>
                <textarea id="motivoCalamidadTexto" placeholder="Especifique aquí la razón de la inasistencia (calamidad)..."></textarea>
              </div>
            </div>

            <div class="motivo-opcion">
              <input type="radio" name="motivoTipo" id="motivoOtro" value="Otro" />
              <div>
                <label for="motivoOtro"><strong>Otro</strong></label>
                <textarea id="motivoOtroTexto" placeholder="Especifique aquí la razón de la inasistencia (obligatorio si escoge 'Otro')"></textarea>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Firma del acudiente</label>
            <div class="field-hint">Dibuje aquí la firma del acudiente antes de enviar la excusa.</div>
          </div>
          <canvas id="signaturePadExcusa" class="signature-pad"></canvas>
          <div class="button-row">
            <button type="button" class="btn-danger" id="btnLimpiarFirmaExcusa">Limpiar firma</button>
            <button type="submit" class="btn-secondary">Enviar excusa</button>
          </div>
        </form>
      </div>
    </section>

    <!-- FRASE FINAL -->
    <footer class="quote-banner">
      “Familia y escuela caminamos juntos: al colaborar y comunicarnos,
      construimos el mejor camino para el bienestar y aprendizaje de nuestros hijos.”
    </footer>
  </div>

  <!-- FIREBASE + LÓGICA -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, updateDoc, getDocs,
      doc, query, where
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
      authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
      projectId: "diariodeprocesos-6f78d",
      storageBucket: "diariodeprocesos-6f78d.firebasestorage.app",
      messagingSenderId: "487922338632",
      appId: "1:487922338632:web:47fc48c23dbea064b0817d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRegistros = collection(db, "registrosComportamentales");
    const colExcusas   = collection(db, "excusasInasistencia");

    const connStatus = document.getElementById('connStatus');
    function updateConn() {
      if (navigator.onLine) {
        connStatus.className = "connection-status online";
        connStatus.innerHTML = '<span class="connection-dot"></span><span>Online - Conectado</span>';
      } else {
        connStatus.className = "connection-status offline";
        connStatus.innerHTML = '<span class="connection-dot"></span><span>Offline (requiere internet)</span>';
      }
    }
    window.addEventListener('online', updateConn);
    window.addEventListener('offline', updateConn);
    updateConn();

    // TABS
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = {
      observaciones: document.getElementById('tab-observaciones'),
      excusa: document.getElementById('tab-excusa')
    };

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.keys(tabContents).forEach(key => {
          tabContents[key].classList.toggle('active', key === tab);
        });
      });
    });

    function escapeHTML(s) {
      if (!s) return "";
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // ---------- OBSERVACIONES ----------
    const formBuscarObs = document.getElementById('formBuscarObs');
    const docObsInput = document.getElementById('docObs');
    const listaObservaciones = document.getElementById('listaObservaciones');
    const obsResumen = document.getElementById('observacionesResumen');
    const panelFirmaObs = document.getElementById('panelFirmaObs');

    let observacionesActuales = [];
    let obsSeleccionadaId = null;

    formBuscarObs.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!navigator.onLine) {
        alert("Se necesita conexión a internet para consultar.");
        return;
      }

      const docEst = docObsInput.value.trim();
      if (!docEst) {
        alert("Digite el documento del estudiante.");
        return;
      }

      try {
        const q = query(colRegistros, where("documentoEstudiante", "==", docEst));
        const snap = await getDocs(q);
        observacionesActuales = [];
        snap.forEach(d => observacionesActuales.push({ firebaseId: d.id, ...d.data() }));

        obsSeleccionadaId = null;
        firmaInfo.textContent = "Ninguna observación seleccionada.";
        btnEnviarFirmaAcudiente.disabled = true;
        btnEnviarFirmaAcudiente.classList.add("btn-disabled");

        if (observacionesActuales.length === 0) {
          listaObservaciones.innerHTML = '<div class="info-text" style="margin-top:8px;">No se encontraron observaciones para este estudiante.</div>';
          obsResumen.textContent = "";
          panelFirmaObs.style.display = "none";
          return;
        }

        panelFirmaObs.style.display = "block";

        observacionesActuales.sort((a,b) => (b.fecha || "").localeCompare(a.fecha || ""));
        const nombre = observacionesActuales[0].nombreEstudiante || "";
        obsResumen.textContent = `Estudiante: ${nombre} · Total de observaciones: ${observacionesActuales.length}`;

        let html = "";
        observacionesActuales.forEach(r => {
          html += '<div class="obs-card">';
          html += '  <div class="obs-header">';
          html += '    <span>Fecha: ' + escapeHTML(r.fecha || "") + '</span>';
          if (r.firmaAcudiente) {
            html += '    <span class="badge-firmado">Firmada por acudiente</span>';
          } else {
            html += '    <span class="badge-pendiente">Firma del acudiente pendiente</span>';
          }
          html += '  </div>';
          html += '  <div class="obs-body">';
          html += '    <div><span class="obs-label">Comportamiento: </span>' + escapeHTML(r.comportamiento || "") + '</div>';
          html += '    <div><span class="obs-label">Descargos: </span>' + escapeHTML(r.descargos || "") + '</div>';
          html += '    <div><span class="obs-label">Procedimiento: </span>' + escapeHTML(r.procedimiento || "") + '</div>';
          html += '  </div>';
          html += '  <div class="button-row" style="margin-top:8px;">';
          if (!r.firmaAcudiente) {
            html += '    <button type="button" class="btn-primary btn-firmar" data-id="' + r.firebaseId + '" data-fecha="' + escapeHTML(r.fecha || "") + '">Firmar esta anotación</button>';
          } else {
            html += '    <button type="button" class="btn-secondary btn-firmar-seleccionar" data-id="' + r.firebaseId + '" data-fecha="' + escapeHTML(r.fecha || "") + '">Ver esta anotación</button>';
          }
          html += '  </div>';
          html += '</div>';
        });

        listaObservaciones.innerHTML = html;

        document.querySelectorAll('.btn-firmar').forEach(btn => {
          btn.addEventListener('click', () => {
            obsSeleccionadaId = btn.dataset.id;
            const fecha = btn.dataset.fecha || "";
            firmaInfo.textContent = fecha
              ? `Firmando la observación del día ${fecha}.`
              : "Observación seleccionada para firmar.";
            btnEnviarFirmaAcudiente.disabled = false;
            btnEnviarFirmaAcudiente.classList.remove("btn-disabled");
            window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
          });
        });

        document.querySelectorAll('.btn-firmar-seleccionar').forEach(btn => {
          btn.addEventListener('click', () => {
            const fecha = btn.dataset.fecha || "";
            firmaInfo.textContent = fecha
              ? `La observación del día ${fecha} ya fue firmada por el acudiente.`
              : "Esta observación ya cuenta con firma del acudiente.";
            obsSeleccionadaId = null;
            btnEnviarFirmaAcudiente.disabled = true;
            btnEnviarFirmaAcudiente.classList.add("btn-disabled");
          });
        });

      } catch (err) {
        console.error(err);
        alert("Error al consultar observaciones.");
      }
    });

    // FIRMA ACUDIENTE (OBSERVACIONES)
    const firmaCanvas = document.getElementById('signaturePadAcudiente');
    const firmaCtx = firmaCanvas.getContext('2d');
    const firmaInfo = document.getElementById('firmaInfo');
    const btnLimpiarFirmaAcudiente = document.getElementById('btnLimpiarFirmaAcudiente');
    const btnEnviarFirmaAcudiente = document.getElementById('btnEnviarFirmaAcudiente');

    function ajustarCanvasFirmaObs() {
      const w = firmaCanvas.getBoundingClientRect().width || 500;
      firmaCanvas.width = w;
      firmaCanvas.height = 220;
      firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height);
    }
    ajustarCanvasFirmaObs();

    let firmando = false, fx = 0, fy = 0;
    function getPosFirma(e) {
      const rect = firmaCanvas.getBoundingClientRect();
      let x, y;
      if (e.touches && e.touches[0]) {
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      } else {
        x = e.offsetX ?? (e.clientX - rect.left);
        y = e.offsetY ?? (e.clientY - rect.top);
      }
      return { x, y };
    }
    function startFirma(e) {
      e.preventDefault();
      firmando = true;
      const p = getPosFirma(e);
      fx = p.x; fy = p.y;
    }
    function drawFirma(e) {
      if (!firmando) return;
      e.preventDefault();
      const p = getPosFirma(e);
      firmaCtx.strokeStyle = "#0f172a";
      firmaCtx.lineWidth = 2.2;
      firmaCtx.lineCap = "round";
      firmaCtx.beginPath();
      firmaCtx.moveTo(fx, fy);
      firmaCtx.lineTo(p.x, p.y);
      firmaCtx.stroke();
      fx = p.x; fy = p.y;
    }
    function stopFirma(e) { e && e.preventDefault(); firmando = false; }

    firmaCanvas.addEventListener("mousedown", startFirma);
    firmaCanvas.addEventListener("mousemove", drawFirma);
    firmaCanvas.addEventListener("mouseup", stopFirma);
    firmaCanvas.addEventListener("mouseout", stopFirma);
    firmaCanvas.addEventListener("touchstart", startFirma, { passive:false });
    firmaCanvas.addEventListener("touchmove", drawFirma, { passive:false });
    firmaCanvas.addEventListener("touchend", stopFirma, { passive:false });

    btnLimpiarFirmaAcudiente.addEventListener('click', () => {
      firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height);
    });

    btnEnviarFirmaAcudiente.addEventListener('click', async () => {
      if (btnEnviarFirmaAcudiente.disabled) return;
      if (!navigator.onLine) {
        alert("Se necesita conexión a internet para enviar la firma.");
        return;
      }
      if (!obsSeleccionadaId) {
        alert("Primero seleccione una observación con el botón 'Firmar esta anotación'.");
        return;
      }

      try {
        const firmaData = firmaCanvas.toDataURL("image/png");
        const hoy = new Date().toLocaleDateString("es-CO");
        await updateDoc(doc(db, "registrosComportamentales", obsSeleccionadaId), {
          firmaAcudiente: firmaData,
          fechaFirmaAcudiente: hoy
        });
        alert("Firma enviada correctamente.");
        firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height);
        firmaInfo.textContent = "Ninguna observación seleccionada.";
        obsSeleccionadaId = null;
        btnEnviarFirmaAcudiente.disabled = true;
        btnEnviarFirmaAcudiente.classList.add("btn-disabled");

        if (docObsInput.value.trim()) {
          formBuscarObs.dispatchEvent(new Event("submit"));
        }
      } catch (err) {
        console.error(err);
        alert("Error al enviar la firma. Intente nuevamente.");
      }
    });

    // ---------- EXCUSA ----------
    const formIdentExcusa = document.getElementById('formIdentExcusa');
    const formExcusa = document.getElementById('formExcusa');
    const docExcusa = document.getElementById('docExcusa');
    const fechaInasistencia = document.getElementById('fechaInasistencia');
    const excusaResumen = document.getElementById('excusaResumen');

    const motivoEnfermedad = document.getElementById('motivoEnfermedad');
    const motivoCita = document.getElementById('motivoCita');
    const motivoCalamidad = document.getElementById('motivoCalamidad');
    const motivoOtro = document.getElementById('motivoOtro');

    const motivoEnfermedadTexto = document.getElementById('motivoEnfermedadTexto');
    const motivoCitaTexto = document.getElementById('motivoCitaTexto');
    const motivoCalamidadTexto = document.getElementById('motivoCalamidadTexto');
    const motivoOtroTexto = document.getElementById('motivoOtroTexto');

    const canvasExcusa = document.getElementById('signaturePadExcusa');
    const ctxExcusa = canvasExcusa.getContext('2d');

    let firmandoExcusa = false, ex = 0, ey = 0;
    let excusaTieneTrazo = false;       // ¿dibujó algo?
    let firmaExcusaDataURL = null;      // copia de seguridad de la firma

    function ajustarCanvasExcusa(redibujar = true) {
      const w = canvasExcusa.getBoundingClientRect().width || 500;
      const h = 220;

      canvasExcusa.width = w;
      canvasExcusa.height = h;
      ctxExcusa.clearRect(0, 0, w, h);

      if (redibujar && firmaExcusaDataURL) {
        const img = new Image();
        img.onload = () => {
          ctxExcusa.drawImage(img, 0, 0, w, h);
        };
        img.src = firmaExcusaDataURL;
      }
    }

    // Inicial
    ajustarCanvasExcusa(false);
    // Si la pantalla cambia de tamaño, redibujamos la firma guardada
    window.addEventListener('resize', () => ajustarCanvasExcusa(true));

    function getPosExcusa(e) {
      const rect = canvasExcusa.getBoundingClientRect();
      let x, y;
      if (e.touches && e.touches[0]) {
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      } else {
        x = e.offsetX ?? (e.clientX - rect.left);
        y = e.offsetY ?? (e.clientY - rect.top);
      }
      return { x, y };
    }

    function startExcusa(e) {
      e.preventDefault();
      firmandoExcusa = true;
      const p = getPosExcusa(e);
      ex = p.x; ey = p.y;
    }

    function drawExcusa(e) {
      if (!firmandoExcusa) return;
      e.preventDefault();
      const p = getPosExcusa(e);
      ctxExcusa.strokeStyle = "#0f172a";
      ctxExcusa.lineWidth = 2.2;
      ctxExcusa.lineCap = "round";
      ctxExcusa.beginPath();
      ctxExcusa.moveTo(ex, ey);
      ctxExcusa.lineTo(p.x, p.y);
      ctxExcusa.stroke();
      ex = p.x; ey = p.y;
      excusaTieneTrazo = true;
    }

    function stopExcusa(e) {
      e && e.preventDefault();
      firmandoExcusa = false;
      // Guardamos una copia de la firma cada vez que termina un trazo
      if (excusaTieneTrazo) {
        firmaExcusaDataURL = canvasExcusa.toDataURL("image/png");
      }
    }

    canvasExcusa.addEventListener("mousedown", startExcusa);
    canvasExcusa.addEventListener("mousemove", drawExcusa);
    canvasExcusa.addEventListener("mouseup", stopExcusa);
    canvasExcusa.addEventListener("mouseout", stopExcusa);
    canvasExcusa.addEventListener("touchstart", startExcusa, { passive:false });
    canvasExcusa.addEventListener("touchmove", drawExcusa, { passive:false });
    canvasExcusa.addEventListener("touchend", stopExcusa, { passive:false });

    document.getElementById('btnLimpiarFirmaExcusa').addEventListener('click', () => {
      ctxExcusa.clearRect(0, 0, canvasExcusa.width, canvasExcusa.height);
      excusaTieneTrazo = false;
      firmaExcusaDataURL = null;
    });

    // Buscar nombre según documento y mostrar formulario
    formIdentExcusa.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!navigator.onLine) {
        alert("Se necesita conexión a internet para continuar.");
        return;
      }

      const docEst = docExcusa.value.trim();
      if (!docEst) {
        alert("Digite el documento del estudiante.");
        return;
      }

      try {
        let nombre = "";

        const q = query(colRegistros, where("documentoEstudiante", "==", docEst));
        const snap = await getDocs(q);
        snap.forEach(d => {
          const data = d.data();
          if (!nombre && data.nombreEstudiante) {
            nombre = data.nombreEstudiante;
          }
        });

        // estudiante ficticio de pruebas
        if (!nombre && docEst === "15271403") {
          nombre = "OSCAR BARRIENTOS";
        }

        if (nombre) {
          excusaResumen.textContent = "Estudiante: " + nombre;
        } else {
          excusaResumen.textContent = "Estudiante aún no registrado en el sistema. La excusa se asociará al documento.";
        }

        formExcusa.style.display = "block";
        fechaInasistencia.valueAsDate = new Date();
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

      } catch (err) {
        console.error(err);
        alert("No fue posible verificar el estudiante. Intente nuevamente.");
      }
    });

    formExcusa.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!navigator.onLine) {
        alert("Se necesita conexión a internet para enviar la excusa.");
        return;
      }

      const docEst = docExcusa.value.trim();
      const fechaIna = fechaInasistencia.value;

      if (!docEst || !fechaIna) {
        alert("Complete el documento del estudiante y la fecha de inasistencia.");
        return;
      }

      let motivoTipo = null;
      let motivoDetalle = "";

      if (motivoEnfermedad.checked) {
        motivoTipo = "Enfermedad";
        motivoDetalle = motivoEnfermedadTexto.value.trim();
        if (!motivoDetalle) {
          alert("Por favor explique brevemente la situación de enfermedad.");
          return;
        }
      } else if (motivoCita.checked) {
        motivoTipo = "Cita médica";
        motivoDetalle = motivoCitaTexto.value.trim();
        if (!motivoDetalle) {
          alert("Por favor explique brevemente la cita médica.");
          return;
        }
      } else if (motivoCalamidad.checked) {
        motivoTipo = "Calamidad";
        motivoDetalle = motivoCalamidadTexto.value.trim();
        if (!motivoDetalle) {
          alert("Por favor explique brevemente la calamidad.");
          return;
        }
      } else if (motivoOtro.checked) {
        motivoTipo = "Otro";
        motivoDetalle = motivoOtroTexto.value.trim();
        if (!motivoDetalle) {
          alert("Explique el motivo en el cuadro de texto de 'Otro'.");
          return;
        }
      }

      if (!motivoTipo) {
        alert("Seleccione un motivo de la inasistencia.");
        return;
      }

      // Verificar que haya firma guardada
      if (!firmaExcusaDataURL || !excusaTieneTrazo) {
        alert("Por favor dibuje la firma del acudiente antes de enviar la excusa.");
        return;
      }

      try {
        const fechaEnvio = new Date().toISOString();

        await addDoc(colExcusas, {
          documentoEstudiante: docEst,
          fechaInasistencia: fechaIna,
          motivoTipo,
          motivoDetalle,
          firmaAcudiente: firmaExcusaDataURL,
          fechaEnvio
        });

        alert(
          "Recuerde que es responsabilidad del estudiante ponerse al día con las actividades delegadas durante su ausencia.\n\n" +
          "Solamente se le reconocerán las notas por los trabajos correspondientes a la jornada en la que no asistió si presenta la excusa."
        );

        formExcusa.reset();
        ctxExcusa.clearRect(0, 0, canvasExcusa.width, canvasExcusa.height);
        excusaTieneTrazo = false;
        firmaExcusaDataURL = null;
        fechaInasistencia.valueAsDate = new Date();

      } catch (err) {
        console.error(err);
        alert("Error al enviar la excusa. Intente nuevamente.");
      }
    });

    fechaInasistencia.valueAsDate = new Date();
  </script>
</body>
</html>
