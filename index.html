<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<title>Mar√≠aJuana ¬∑ Padres de Familia</title>
<meta name="theme-color" content="#1b5e20" />
<meta name="mobile-web-app-capable" content="yes">

<link rel="manifest" href="./manifest.json?v=2">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  /* BASE Y RESET */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: system-ui, Arial, sans-serif; background: #dff5e1; padding-bottom: 95px; user-select: none; overflow-x: hidden; }
  
  /* ENCABEZADO */
  .header { background: #1b5e20; color: #fff; text-align: center; padding: 20px 16px 35px; border-radius: 0 0 30px 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .header img { width: 90px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); display: inline-block; }
  .header h2 { margin: 5px 0; font-size: 22px; letter-spacing: -0.5px; }
  .header h4 { margin: 5px 0; font-weight: 500; opacity: 0.9; font-size: 14px; }
  .header strong { display: block; margin-top: 8px; font-size: 15px; color: #a5d6a7; }

  /* MEN√ö FLOTANTE */
  .menu { display: flex; justify-content: space-around; gap: 10px; background: #2e7d32; padding: 8px; margin: -25px auto 20px; width: 92%; border-radius: 999px; box-shadow: 0 6px 12px rgba(0,0,0,0.15); position: relative; z-index: 10; }
  .menu button { flex: 1; border: none; padding: 12px 14px; border-radius: 999px; font-weight: 800; cursor: pointer; background: rgba(255,255,255,0.1); color: #fff; transition: all 0.2s; font-size: 13px; }
  .menu button.active { background: #fff; color: #1b5e20; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  /* CONTENEDORES */
  .container { background: #fff; width: 92%; margin: 10px auto; padding: 20px 16px; border-radius: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
  
  /* FORMULARIOS */
  .input-label { font-weight: 700; color: #1b5e20; font-size: 13px; margin-left: 4px; margin-bottom: 4px; display: block; }
  input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 16px; background: #f9f9f9; transition: all 0.3s; appearance: none; }
  input:focus, textarea:focus, select:focus { outline: none; border-color: #1b5e20; background: #fff; }

  /* BOTONES */
  .btn { width: 100%; padding: 15px; background: #1b5e20; color: #fff; font-weight: 800; border: none; border-radius: 14px; cursor: pointer; font-size: 15px; box-shadow: 0 4px 0 #145018; margin-top: 5px; }
  .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #145018; }
  .btn.blue { background: #0277bd; box-shadow: 0 4px 0 #01579b; }
  .btn.sec { background: #546e7a; box-shadow: 0 4px 0 #37474f; }

  /* CUADROS ASISTENCIA */
  .att-summary { display: flex; gap: 10px; margin-bottom: 15px; }
  .att-box { flex: 1; text-align: center; padding: 10px 5px; border-radius: 12px; color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .att-red { background: #ef4444; } .att-orange { background: #f97316; } .att-green { background: #22c55e; }
  .att-num { font-size: 22px; font-weight: 900; display: block; }
  .att-lbl { font-size: 10px; text-transform: uppercase; font-weight: 700; opacity: 0.9; }

  /* OPTIMIZACI√ìN DEL CAMPO DE FIRMA */
  .sig-wrap { 
    margin-top: 15px; padding: 5px; border-radius: 14px; background: #ffffff; border: 2px solid #1b5e20; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
  }
  canvas { width: 100%; height: 180px; border-radius: 10px; background: transparent; touch-action: none; display: block; cursor: crosshair; }
  .sig-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #bdbdbd; font-size: 14px; font-weight: 500; pointer-events: none; text-transform: uppercase; z-index: 1; }
  .sig-line { position: absolute; bottom: 40px; left: 10%; right: 10%; height: 1px; background: #e0e0e0; pointer-events: none; }
  .sig-actions { display: flex; gap: 8px; margin-top: 10px; }
  .btn-clear { background: #eceff1; color: #455a64; border: 1px solid #cfd8dc; padding: 10px; border-radius: 8px; font-size: 12px; font-weight: bold; flex: 0.4; border: none; cursor: pointer; }

  /* OBSERVACIONES */
  .card { margin-top: 15px; border-radius: 16px; overflow: hidden; border: 1px solid #eee; background: #fff; }
  .card .top { padding: 10px 12px; font-weight: 900; color: #fff; display: flex; justify-content: space-between; }
  .card .body { padding: 15px; font-size: 14px; }
  .row b { display: block; color: #1b5e20; font-size: 11px; text-transform: uppercase; margin-top: 8px; }

  /* MODAL SOPORTE */
  #modalSoporte { display: none; background: #fff; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; overflow-y: auto; }
  .modal-header { background: #1b5e20; color: #fff; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 10; font-weight: bold; }
  .modal-header .close { position: absolute; left: 15px; top: 18px; font-size: 24px; background: none; border: none; color: #fff; cursor: pointer; }
  .modal-body { padding: 20px; max-width: 500px; margin: 0 auto; }

  .history-card { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #455a64; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .teacher-reply { background: #f3e5f5; border-left: 5px solid #6a1b9a; padding: 12px; border-radius: 8px; margin-top: 12px; color: #4a148c; font-size: 13px; }

  /* BOT√ìN FLOTANTE SOPORTE */
  .btn-support-trigger { display: block; width: 85%; max-width: 300px; padding: 15px; background: #455a64; color: #fff; font-weight: 800; border: none; border-radius: 50px; font-size: 14px; box-shadow: 0 4px 0 #263238; cursor: pointer; margin: 20px auto; text-align: center; }

  /* OVERLAYS */
  .success-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3000; color: white; text-align: center; padding: 40px 20px; justify-content: center; align-items: center; flex-direction: column; }
  .footer { margin: 20px; text-align: center; font-size: 12px; color: #1b5e20; opacity: 0.7; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
  firebase.initializeApp({
    apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
    authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
    projectId: "diariodeprocesos-6f78d"
  });
  const db = firebase.firestore();
</script>
</head>

<body>

  <div class="header">
    <img src="escudo.png" alt="Escudo">
    <h2>Instituci√≥n Educativa de Mar√≠a</h2>
    <h4>Sede Rural Santa Juana ¬∑ Primaria 2026</h4>
    <strong>Docente: Oscar Barrientos</strong>
  </div>

  <div class="menu">
    <button id="btnExc" class="active" onclick="verExc()">Asistencia</button>
    <button id="btnObs" onclick="verObs()">Observaciones</button>
  </div>

  <div id="exc" class="container">
    <span class="input-label">DOCUMENTO DEL ESTUDIANTE</span>
    <input id="docExc" type="number" placeholder="Digite documento..." inputmode="numeric">
    <button id="btnInitExc" class="btn" onclick="activarFormularioExcusa()">CONTINUAR</button>
    
    <div id="contenedorFormExc" style="display:none; margin-top:20px;">
        <div id="nombreExc" style="font-weight:bold; color:#1b5e20; text-align:center; background:#e8f5e9; padding:10px; border-radius:12px 12px 0 0;"></div>
        <div id="periodoLabelPadre" style="background:#1b5e20; color:white; font-size:10px; text-align:center; padding:5px; margin-bottom:15px; border-radius:0 0 12px 12px; font-weight:bold;">Periodo Actual: #1</div>
        
        <div class="att-summary">
            <div class="att-box att-red" onclick="verModalFechas('Fallas')">
                <span class="att-num" id="statFallas">0</span>
                <span class="att-lbl">Fallas</span>
            </div>
            <div class="att-box att-orange" onclick="verModalFechas('Excusas')">
                <span class="att-num" id="statExcusas">0</span>
                <span class="att-lbl">Excusas</span>
            </div>
            <div class="att-box att-green">
                <span class="att-num" id="statEstado">OK</span>
                <span class="att-lbl">Estado</span>
            </div>
        </div>

        <h3 style="margin: 20px 0 10px; font-size: 16px;">Enviar Excusa por Inasistencia</h3>
        <span class="input-label">FECHA DE INASISTENCIA</span>
        <input id="fechaExc" type="date">
        <span class="input-label">MOTIVO</span>
        <select id="motivoExc">
            <option value="Enfermedad">Enfermedad</option>
            <option value="Cita m√©dica">Cita m√©dica</option>
            <option value="Calamidad">Calamidad</option>
            <option value="Otro">Otro</option>
        </select>
        <span class="input-label">DETALLES DE LA JUSTIFICACI√ìN</span>
        <textarea id="detalleExc" placeholder="Escriba los detalles aqu√≠..."></textarea>
        
        <span class="input-label">FIRMA DEL ACUDIENTE (OBLIGATORIA)</span>
        <div class="sig-wrap">
            <div id="placeholder_sigExc" class="sig-placeholder">Firme aqu√≠</div>
            <div class="sig-line"></div>
            <canvas id="sigExc"></canvas>
        </div>
        <div class="sig-actions">
            <button class="btn-clear" onclick="limpiarPad('sigExc')">üîÑ LIMPIAR</button>
        </div>
        <button id="btnEnviarExc" class="btn" style="margin-top:20px" onclick="enviarExcusa()">ENVIAR EXCUSA</button>
    </div>
  </div>

  <div id="obs" class="container" style="display:none;">
    <span class="input-label">DOCUMENTO DEL ESTUDIANTE</span>
    <input id="docObs" type="number" placeholder="Digite documento..." inputmode="numeric">
    <button id="btnBuscar" class="btn" onclick="buscarObservaciones()">VER OBSERVACIONES</button>
    <div id="resultadoObs" style="margin-top:20px;"></div>
  </div>

  <div id="modalSoporte">
    <div class="modal-header"><button class="close" onclick="cerrarSoporte()">‚úï</button>Soporte y Comunicaci√≥n</div>
    <div class="modal-body">
      <div id="sop_step_auth">
        <h3 style="text-align:center">Autenticaci√≥n</h3>
        <input id="docSoporte" type="number" placeholder="Documento del estudiante..." inputmode="numeric">
        <button class="btn" onclick="autenticarSoporte()">INGRESAR</button>
      </div>

      <div id="sop_step_menu" style="display:none">
        <div id="sop_nombre_est" style="font-weight:800; color:#1b5e20; text-align:center; margin-bottom:20px;"></div>
        <button class="btn blue" style="margin-bottom:12px" onclick="irAFormularioMsg()">‚úâÔ∏è ENVIAR MENSAJE AL DOCENTE</button>
        <button class="btn sec" style="background:#6a1b9a;" onclick="irAHistorialMensajes()">üì¨ VER RESPUESTAS DEL DOCENTE</button>
      </div>

      <div id="sop_step_form" style="display:none">
        <h3 style="border-bottom:2px solid #263238; padding-bottom:10px; margin-bottom:15px;">Nuevo Mensaje</h3>
        <span class="input-label">ASUNTO</span>
        <input id="msg_asunto" type="text" placeholder="Duda, inquietud, sugerencia...">
        <span class="input-label">CONTENIDO</span>
        <textarea id="msg_texto" placeholder="Escriba aqu√≠ su mensaje..."></textarea>
        <span class="input-label">FIRMA ACUDIENTE</span>
        <div class="sig-wrap">
            <div id="placeholder_sigSop" class="sig-placeholder">Firme aqu√≠</div>
            <div class="sig-line"></div>
            <canvas id="sigSoporte"></canvas>
        </div>
        <button class="btn sec" style="margin:10px 0" onclick="limpiarPad('sigSoporte')">LIMPIAR FIRMA</button>
        <button class="btn" id="btnEnviarSop" onclick="enviarMensajeSoporte()">ENVIAR MENSAJE</button>
      </div>

      <div id="sop_step_history" style="display:none">
        <h3 style="color:#6a1b9a;">Historial de Mensajes</h3>
        <button class="btn sec" style="margin-bottom:15px; font-size:12px; padding:8px;" onclick="volverMenuSoporte()">‚Üê VOLVER</button>
        <div id="listaMensajesRespuestas"></div>
      </div>
    </div>
  </div>

  <button class="btn-support-trigger" onclick="abrirSoporte()">üí¨ Comunicaci√≥n y Soporte</button>

  <div id="successAsistencia" class="success-overlay" style="background: rgba(27, 94, 32, 0.98);">
    <h2>‚úÖ ¬°Env√≠o Exitoso!</h2>
    <p style="padding:20px">‚ÄúRecuerda que es responsabilidad del estudiante ponerse al d√≠a con las actividades acad√©micas.‚Äù</p>
    <button class="btn" style="background:white; color:#1b5e20; width:200px" onclick="location.reload()">ENTENDIDO</button>
  </div>

  <div class="footer">‚ÄúFamilia y escuela caminamos juntos‚Äù</div>

<script>
  const estudiantesValidos = [
    { doc: "1157463842", nombre: "BERRIO CORREA VALENTINA" },
    { doc: "1038213324", nombre: "GUZMAN CORREA DYLAN" },
    { doc: "1072263423", nombre: "MEDINA POLO JESUS DAVID" },
    { doc: "1041636093", nombre: "MEJIA VALLEJO TOMAS" },
    { doc: "1041636021", nombre: "VARELAS BARRIENTOS MAXIMILIANO" }
  ];

  let periodoActualAsis = 1;
  let estActualSoporte = null;
  const pads = new Map();

  // --- FIRMA OPTIMIZADA ---
  function initPad(id) {
    const c = document.getElementById(id);
    if (!c) return;
    const ctx = c.getContext("2d");
    const placeholder = document.getElementById('placeholder_' + id);
    const ratio = window.devicePixelRatio || 1;
    const rect = c.getBoundingClientRect();
    c.width = rect.width * ratio; c.height = 180 * ratio; ctx.scale(ratio, ratio);
    ctx.lineWidth = 2.5; ctx.lineCap = "round"; ctx.strokeStyle = "#000b45";
    let drawing = false;
    const getPos = (e) => {
      const r = c.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - r.left, y: clientY - r.top };
    };
    const start = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); if (placeholder) placeholder.style.display = 'none'; };
    const move = (e) => { if (!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); pads.set(id, { ctx, c, hasData: true }); };
    const stop = () => { drawing = false; };
    c.addEventListener("mousedown", start); c.addEventListener("mousemove", move); window.addEventListener("mouseup", stop);
    c.addEventListener("touchstart", (e) => { e.preventDefault(); start(e); }, { passive: false });
    c.addEventListener("touchmove", (e) => { e.preventDefault(); move(e); }, { passive: false });
    c.addEventListener("touchend", stop);
    pads.set(id, { ctx, c, hasData: false });
  }

  function limpiarPad(id) {
    const p = pads.get(id);
    if (p) { p.ctx.clearRect(0, 0, p.c.width, p.c.height); p.hasData = false;
      const ph = document.getElementById('placeholder_' + id); if (ph) ph.style.display = 'block';
    }
  }

  // --- ASISTENCIA Y PERIODO ---
  async function activarFormularioExcusa() {
    const docInput = document.getElementById("docExc").value.trim();
    const est = estudiantesValidos.find(e => e.doc === docInput);
    if(!est) return alert("Documento no v√°lido.");
    document.getElementById("btnInitExc").style.display="none";
    document.getElementById("contenedorFormExc").style.display="block";
    document.getElementById("nombreExc").innerText = est.nombre;
    const configSnap = await db.collection("configuracionGlobal").doc("asistencia").get();
    if(configSnap.exists()){
        periodoActualAsis = configSnap.data().periodoActual || 1;
        document.getElementById("periodoLabelPadre").innerText = `Periodo Actual: #${periodoActualAsis}`;
    }
    consultarEstadisticas(docInput);
    setTimeout(() => initPad('sigExc'), 300);
  }

  async function consultarEstadisticas(docId) {
    const snap = await db.collection("controlAsistencia").where("periodo", "==", periodoActualAsis).get();
    let f = 0, e = 0;
    snap.forEach(d => {
        const reg = d.data().detalles?.find(x => x.doc === docId);
        if(reg?.estado === 'I') f++; if(reg?.estado === 'E') e++;
    });
    document.getElementById("statFallas").innerText = f;
    document.getElementById("statExcusas").innerText = e;
    document.getElementById("statEstado").innerText = f >= 3 ? "ALERTA" : "OK";
    document.getElementById("statEstado").parentElement.style.background = f >= 3 ? "#d32f2f" : "#22c55e";
  }

  async function enviarExcusa() {
    const p = pads.get("sigExc");
    const fecha = document.getElementById("fechaExc").value;
    if(!fecha || !p?.hasData) return alert("Complete la fecha y firme.");
    const btn = document.getElementById("btnEnviarExc");
    btn.disabled = true; btn.textContent = "ENVIANDO...";
    try {
        await db.collection("excusasInasistencia").add({
            documentoEstudiante: document.getElementById("docExc").value.trim(),
            fechaInasistencia: fecha,
            motivoTipo: document.getElementById("motivoExc").value,
            motivoDetalle: document.getElementById("detalleExc").value.trim(),
            firmaAcudiente: p.c.toDataURL(),
            timestamp: new Date().toISOString()
        });
        document.getElementById("successAsistencia").style.display = "flex";
    } catch(e) { btn.disabled = false; alert("Error al enviar."); }
  }

  // --- OBSERVACIONES ---
  function buscarObservaciones() {
    const docInput = document.getElementById("docObs").value.trim();
    if(!docInput) return alert("Digite documento.");
    const out = document.getElementById("resultadoObs");
    out.innerHTML = "<p style='text-align:center'>Cargando...</p>";
    db.collection("registrosComportamentales").where("documentoEstudiante", "==", docInput).onSnapshot(snap => {
        if(snap.empty) { out.innerHTML = "<p style='text-align:center'>Sin registros.</p>"; return; }
        let html = "";
        snap.forEach(d => {
            const r = d.data();
            html += `<div class="card" style="border-left:5px solid #1b5e20">
                <div class="top" style="background:#1b5e20"><span>ANOTACI√ìN</span><span>${r.firmaAcudiente ? 'FIRMADO' : 'PENDIENTE'}</span></div>
                <div class="body">
                    <div class="row"><b>Fecha:</b> ${r.fecha}</div>
                    <div class="row"><b>Descripci√≥n:</b> ${r.comportamiento}</div>
                    ${!r.firmaAcudiente ? `
                        <div class="sig-wrap"><canvas id="cv_${d.id}"></canvas></div>
                        <button class="btn" onclick="firmarObsPadre('${d.id}')">FIRMAR RECIBIDO</button>
                    ` : `<div style="text-align:center;margin-top:10px"><img src="${r.firmaAcudiente}" style="max-height:60px"></div>`}
                </div>
            </div>`;
        });
        out.innerHTML = html;
        snap.forEach(d => { if(!d.data().firmaAcudiente) setTimeout(()=>initPad("cv_"+d.id), 500); });
    });
  }

  async function firmarObsPadre(id) {
    const p = pads.get("cv_"+id); if(!p?.hasData) return alert("Firme el cuadro.");
    await db.collection("registrosComportamentales").doc(id).update({ firmaAcudiente: p.c.toDataURL(), fechaFirmaAcudiente: new Date().toISOString() });
  }

  // --- SOPORTE Y COMUNICACI√ìN ---
  function abrirSoporte() { document.getElementById("modalSoporte").style.display = "block"; }
  function cerrarSoporte() { document.getElementById("modalSoporte").style.display = "none"; }
  function volverMenuSoporte() { document.getElementById("sop_step_history").style.display = "none"; document.getElementById("sop_step_form").style.display = "none"; document.getElementById("sop_step_menu").style.display = "block"; }

  function autenticarSoporte() {
    const doc = document.getElementById("docSoporte").value.trim();
    const est = estudiantesValidos.find(e => e.doc === doc);
    if(est) {
      estActualSoporte = est;
      document.getElementById("sop_step_auth").style.display = "none";
      document.getElementById("sop_step_menu").style.display = "block";
      document.getElementById("sop_nombre_est").innerText = "Estudiante: " + est.nombre;
    } else alert("No encontrado.");
  }

  function irAFormularioMsg() {
    document.getElementById("sop_step_menu").style.display = "none";
    document.getElementById("sop_step_form").style.display = "block";
    setTimeout(() => initPad('sigSoporte'), 300);
  }

  async function enviarMensajeSoporte() {
    const p = pads.get("sigSoporte");
    const asunto = document.getElementById("msg_asunto").value.trim();
    const texto = document.getElementById("msg_texto").value.trim();
    if(!asunto || !texto || !p?.hasData) return alert("Complete los campos y firme.");
    await db.collection("comunicacionPadres").add({
      documentoEstudiante: estActualSoporte.doc,
      nombreEstudiante: estActualSoporte.nombre,
      asunto: asunto, mensaje: texto,
      firma: p.c.toDataURL(), timestamp: new Date().toISOString()
    });
    alert("Mensaje enviado con √©xito.");
    volverMenuSoporte();
  }

  function irAHistorialMensajes() {
    document.getElementById("sop_step_menu").style.display = "none";
    document.getElementById("sop_step_history").style.display = "block";
    db.collection("comunicacionPadres").where("documentoEstudiante", "==", estActualSoporte.doc).onSnapshot(snap => {
        let html = "";
        snap.forEach(d => {
            const m = d.data();
            html += `<div class="history-card"><b>${m.asunto}</b><p>${m.mensaje}</p>${m.respuestaDocente ? `<div class="teacher-reply"><b>Docente:</b> ${m.respuestaDocente}</div>` : ''}</div>`;
        });
        document.getElementById("listaMensajesRespuestas").innerHTML = html || "Sin mensajes.";
    });
  }

  function verObs(){ document.getElementById("obs").style.display="block"; document.getElementById("exc").style.display="none"; document.getElementById("btnObs").className="active"; document.getElementById("btnExc").className=""; }
  function verExc(){ document.getElementById("obs").style.display="none"; document.getElementById("exc").style.display="block"; document.getElementById("btnExc").className="active"; document.getElementById("btnObs").className=""; }
</script>
</body>
</html>
