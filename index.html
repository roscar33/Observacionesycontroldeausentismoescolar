<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<title>Seguimiento de Procesos Escolares ¬∑ Primaria 2026</title>
<meta name="theme-color" content="#1b5e20" />
<meta name="mobile-web-app-capable" content="yes">

<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: system-ui, Arial, sans-serif; background: #dff5e1; padding-bottom: 95px; user-select: none; }

  .header { background: #1b5e20; color: #fff; text-align: center; padding: 20px 16px 35px; border-radius: 0 0 30px 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .header img { width: 90px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); display: inline-block; }
  .header h2 { margin: 5px 0; font-size: 22px; letter-spacing: -0.5px; }
  .header h4 { margin: 5px 0; font-weight: 500; opacity: 0.9; font-size: 14px; }
  .header strong { display: block; margin-top: 8px; font-size: 15px; color: #a5d6a7; }
  .header p { margin: 5px 0 0; font-size: 13px; opacity: 0.8; }

  .menu { display: flex; justify-content: space-around; gap: 10px; background: #2e7d32; padding: 8px; margin: -25px auto 20px; width: 92%; border-radius: 999px; box-shadow: 0 6px 12px rgba(0,0,0,0.15); position: relative; z-index: 10; }
  .menu button { flex: 1; border: none; padding: 12px 14px; border-radius: 999px; font-weight: 800; cursor: pointer; background: rgba(255,255,255,0.1); color: #fff; transition: all 0.2s; font-size: 14px; }
  .menu button.active { background: #fff; color: #1b5e20; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  .container { background: #fff; width: 92%; margin: 10px auto; padding: 20px 16px; border-radius: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }

  .input-label { font-weight: 700; color: #1b5e20; font-size: 13px; margin-left: 4px; margin-bottom: 4px; display: block; }
  input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 16px; background: #f9f9f9; transition: border 0.3s; appearance: none; -webkit-appearance: none; }
  input:focus, textarea:focus, select:focus { outline: none; border-color: #1b5e20; background: #fff; }
  textarea { min-height: 110px; resize: none; }

  .remember-box { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; color: #555; }
  .remember-box input { width: auto; margin: 0; }

  .btn { width: 100%; padding: 15px; background: #1b5e20; color: #fff; font-weight: 800; border: none; border-radius: 14px; cursor: pointer; font-size: 15px; box-shadow: 0 4px 0 #145018; margin-top: 5px; }
  .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #145018; }
  .btn.sec { background: #546e7a; box-shadow: 0 4px 0 #37474f; }
  .btn.blue { background: #0277bd; box-shadow: 0 4px 0 #01579b; }

  /* ---- CINTILLA ESTUDIANTE + PERIODO ---- */
  .student-ribbon { border-radius: 14px; overflow: hidden; margin-bottom: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.10); }
  .student-ribbon .name { background: #1b5e20; color: #fff; font-weight: 900; text-align: center; padding: 12px 10px; letter-spacing: 0.3px; }
  .student-ribbon .period { background: #145018; color: #fff; font-weight: 900; text-align: center; padding: 10px 10px; font-size: 12px; letter-spacing: 0.4px; text-transform: uppercase; }

  /* ---- Estad√≠sticas Asistencia ---- */
  .att-summary { display: flex; gap: 10px; margin-bottom: 15px; }
  .att-box { flex: 1; text-align: center; padding: 10px 5px; border-radius: 12px; color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; user-select: none; }
  .att-red { background: #ef4444; }
  .att-orange { background: #f97316; }
  .att-green { background: #22c55e; }
  .att-num { font-size: 22px; font-weight: 900; display: block; }
  .att-lbl { font-size: 10px; text-transform: uppercase; font-weight: 700; opacity: 0.9; }

  /* ---- OBSERVACIONES ---- */
  .card { margin-top: 15px; border-radius: 16px; overflow: hidden; border: 1px solid #eee; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
  .card .top { padding: 10px 12px; font-weight: 900; color: #fff; display: flex; justify-content: space-between; align-items: center; }
  .badge { padding: 4px 8px; border-radius: 6px; background: rgba(0,0,0,0.2); font-size: 11px; font-weight: 800; letter-spacing: 0.5px; }
  .card .body { padding: 15px; color: #333; font-size: 14px; line-height: 1.5; }
  .row { margin-top: 10px; }
  .row b { display: block; margin-bottom: 3px; color: #1b5e20; font-size: 12px; text-transform: uppercase; }

  /* ---- Firma ---- */
  .sig-wrap { margin-top: 15px; padding: 10px; border-radius: 14px; background: #f1f5f9; border: 2px dashed #b0bec5; }
  canvas { width: 100%; height: 180px; border-radius: 8px; background: #fff; touch-action: none; display: block; }
  .sig-actions { display: flex; gap: 10px; margin-top: 10px; }
  .sig-actions button { flex: 1; padding: 10px; font-size: 13px; margin-top: 0; box-shadow: none !important; }

  .new-item { border: 2px solid #d32f2f; animation: pulse 2s infinite; }
  .new-tag { background: #d32f2f; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 5px; vertical-align: middle; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }

  /* Toast */
  #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
  #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 4.5s; }
  @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
  @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

  /* Modal fechas (Asistencia) */
  #modalFechas { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; z-index: 4000; padding: 20px; }
  .mf-card{ background:#fff; max-width:520px; margin: 40px auto; border-radius: 18px; overflow:hidden; box-shadow: 0 12px 40px rgba(0,0,0,0.25); }
  .mf-head{ background:#1b5e20; color:#fff; font-weight:900; padding: 14px 16px; position: relative; text-align:center; }
  .mf-close{ position:absolute; left: 10px; top: 8px; border:none; background: rgba(255,255,255,0.2); color:#fff; font-size:18px; width:36px; height:36px; border-radius: 12px; cursor:pointer; }
  .mf-body{ padding: 16px; }
  .mf-pill{ display:inline-block; padding: 6px 10px; border-radius: 999px; background:#e8f5e9; color:#145018; font-weight:800; font-size:12px; margin-bottom:10px; }
  .mf-list{ margin: 0; padding-left: 18px; line-height: 1.7; color:#222; font-weight: 700; }
  .mf-empty{ text-align:center; padding: 16px; color:#666; font-weight: 700; }

  /* ‚úÖ Overlays */
  .success-overlay{
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    z-index:6000;
    color:white;
    text-align:center;
    padding:40px 20px;
    justify-content:center;
    align-items:center;
    flex-direction:column;
  }

  /* ‚úÖ Soporte */
  #modalSoporte { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 5000; display: none; overflow-y: auto; }
  .modal-header { background: #263238; color: #fff; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 10; }
  .modal-header .close { position: absolute; left: 15px; top: 18px; font-size: 24px; background: none; border: none; color: #fff; cursor: pointer; }
  .modal-body { padding: 20px; max-width: 520px; margin: 0 auto; }

  .welcome-soporte { background: #e3f2fd; border-left: 5px solid #0288d1; padding: 20px; border-radius: 12px; margin-bottom: 20px; color: #01579b; line-height: 1.6; font-size: 15px; }

  .history-card { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #455a64; }
  .history-header { display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 4px; gap: 10px; }
  .history-body { font-size: 14px; color: #333; line-height: 1.4; }
  .teacher-reply { background: #f3e5f5; border-left: 5px solid #6a1b9a; padding: 12px; border-radius: 8px; margin-top: 12px; color: #4a148c; font-size: 13px; }

  .btn-support-trigger { display: block; width: auto; min-width: 240px; padding: 15px 25px; background: #455a64; color: #fff; font-weight: 800; border: none; border-radius: 50px; font-size: 14px; box-shadow: 0 4px 0 #263238; cursor: pointer; margin: 20px auto; }

  .footer { margin: 30px 18px 10px; text-align: center; font-size: 13px; font-weight: 600; color: #145018; opacity: 0.8; padding-bottom: 20px; line-height: 1.4; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
  firebase.initializeApp({
    apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
    authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
    projectId: "diariodeprocesos-6f78d"
  });
  const db = firebase.firestore();
</script>
</head>

<body>

  <div class="header">
    <img src="escudo.png" alt="Escudo I.E. De Mar√≠a" onerror="this.onerror=null; this.src='https://placehold.co/100x100/1b5e20/ffffff?text=IE+De+Maria';">
    <h2>Instituci√≥n Educativa de Mar√≠a</h2>
    <h4>Sede Rural Santa Juana ¬∑ Primaria 2026</h4>
    <strong>Docente: Oscar Barrientos</strong>
    <p>Seguimiento de Procesos Escolares</p>
  </div>

  <!-- ‚úÖ ORDEN: ASISTENCIA PRIMERO -->
  <div class="menu">
    <button id="btnExc" class="active" onclick="verExc()">Excusas / Asistencia</button>
    <button id="btnObs" onclick="verObs()">Observaciones</button>
  </div>

  <!-- SECCI√ìN: ASISTENCIA Y EXCUSAS -->
  <div id="exc" class="container">
    <span class="input-label">DOCUMENTO DEL ESTUDIANTE</span>
    <input id="docExc" type="number" placeholder="Digite documento..." inputmode="numeric">

    <div class="remember-box">
      <input type="checkbox" id="chkRemExc">
      <label for="chkRemExc">Recordar documento en este dispositivo</label>
    </div>

    <button id="btnInitExc" class="btn" onclick="activarFormularioExcusa()">CONTINUAR</button>

    <div id="contenedorFormExc" style="display:none; border-top:1px solid #eee; padding-top:20px; margin-top:20px;">

      <div class="student-ribbon">
        <div id="ribbonNombre" class="name">ESTUDIANTE</div>
        <div id="ribbonPeriodo" class="period">PERIODO: CARGANDO...</div>
      </div>

      <div class="att-summary">
        <div class="att-box att-red" id="boxFallas" onclick="mostrarFechas('fallas')">
          <span class="att-num" id="statFallas">0</span><span class="att-lbl">Fallas</span>
        </div>
        <div class="att-box att-orange" id="boxExcusas" onclick="mostrarFechas('excusas')">
          <span class="att-num" id="statExcusas">0</span><span class="att-lbl">Excusas</span>
        </div>
        <div class="att-box att-green" id="boxEstado">
          <span class="att-num" id="statEstado">OK</span><span class="att-lbl">Estado</span>
        </div>
      </div>

      <h3 style="margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px;">Enviar Excusa</h3>

      <span class="input-label">FECHA DE INASISTENCIA</span>
      <input id="fechaExc" type="date">

      <span class="input-label">MOTIVO</span>
      <select id="motivoExc">
        <option value="Enfermedad">Enfermedad</option>
        <option value="Cita m√©dica">Cita m√©dica</option>
        <option value="Calamidad">Calamidad</option>
        <option value="Otro">Otro</option>
      </select>

      <span class="input-label">DETALLES</span>
      <textarea id="detalleExc" placeholder="Describa el motivo detalladamente..."></textarea>

      <span class="input-label">FIRMA DEL ACUDIENTE (OBLIGATORIA)</span>
      <div class="sig-wrap">
        <canvas id="sigExc"></canvas>
        <button class="btn sec" style="margin-top:10px" onclick="limpiarPad('sigExc')">Borrar Firma</button>
      </div>

      <button id="btnEnviarExc" class="btn" onclick="enviarExcusa()">ENVIAR EXCUSA</button>
    </div>
  </div>

  <!-- SECCI√ìN: OBSERVACIONES -->
  <div id="obs" class="container" style="display:none;">
    <span class="input-label">DOCUMENTO DEL ESTUDIANTE</span>
    <input id="docObs" type="number" placeholder="Digite documento..." inputmode="numeric">

    <div class="remember-box">
      <input type="checkbox" id="chkRemObs">
      <label for="chkRemObs">Recordar documento en este dispositivo</label>
    </div>

    <button id="btnBuscar" class="btn" onclick="buscarObservaciones()">VER OBSERVACIONES</button>
    <div id="resultadoObs" style="margin-top:20px;"></div>
  </div>

  <!-- MODAL FECHAS (Asistencia) -->
  <div id="modalFechas" onclick="if(event.target.id==='modalFechas') cerrarModalFechas()">
    <div class="mf-card">
      <div class="mf-head" id="mfTitulo">
        <button class="mf-close" onclick="cerrarModalFechas()">‚úï</button>
        Fechas
      </div>
      <div class="mf-body">
        <div class="mf-pill" id="mfSub">Periodo</div>
        <div id="mfContenido"></div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ SOPORTE -->
  <div id="modalSoporte">
    <div class="modal-header">
      <button class="close" onclick="cerrarSoporte()">‚úï</button>
      Soporte y Comunicaci√≥n
    </div>
    <div class="modal-body">

      <div id="sop_step_auth">
        <h3 style="text-align:center">Autenticaci√≥n</h3>
        <input id="docSoporte" type="number" placeholder="Documento del estudiante..." inputmode="numeric">
        <button class="btn" onclick="autenticarSoporte()">INGRESAR</button>
      </div>

      <div id="sop_step_menu" style="display:none">
        <div id="sop_nombre_est" style="font-weight:800; color:#1b5e20; text-align:center; margin-bottom:20px;"></div>
        <button class="btn blue" style="margin-bottom:12px" onclick="alert('Descargando Horario Escolar...')">üìÖ HORARIO ESCOLAR</button>
        <button class="btn blue" style="margin-bottom:12px" onclick="alert('Lista de √ötiles 2026...')">üìö √öTILES ESCOLARES 2026</button>
        <button class="btn" style="margin-bottom:12px" onclick="irAInfoComunicacion()">‚úâÔ∏è COMUNICARSE CON EL DOCENTE</button>
        <button class="btn sec" style="background:#6a1b9a;" onclick="irAHistorialMensajes()">üì¨ VER RESPUESTAS DEL DOCENTE</button>
      </div>

      <div id="sop_step_info" style="display:none">
        <div class="welcome-soporte">
          <strong>Bienvenido, padre de familia.</strong><br><br>
          Este espacio le permite comunicarse directamente con el docente.<br>
          Aqu√≠ puede escribir inquietudes, dudas, sugerencias o informar cualquier novedad relacionada con la vida escolar de su hijo.<br><br>
          Le invitamos a expresarse con respeto y claridad.
        </div>
        <button class="btn" onclick="irAFormularioMsg()">ENTENDIDO</button>
      </div>

      <div id="sop_step_form" style="display:none">
        <h3 style="border-bottom:2px solid #263238; padding-bottom:10px; margin-bottom:15px;">Nuevo Mensaje</h3>

        <span class="input-label">FECHA</span>
        <input id="msg_fecha" type="date">

        <span class="input-label">ASUNTO</span>
        <input id="msg_asunto" type="text" placeholder="Inquietud, duda, sugerencia...">

        <span class="input-label">CONTENIDO DEL MENSAJE</span>
        <textarea id="msg_texto" placeholder="Escriba aqu√≠ su mensaje detallado..."></textarea>

        <span class="input-label">FIRMA (OBLIGATORIA)</span>
        <div class="sig-wrap">
          <canvas id="sigSoporte"></canvas>
          <button class="btn sec" style="margin-top:10px" onclick="limpiarPad('sigSoporte')">Borrar Firma</button>
        </div>

        <button class="btn" id="btnEnviarSop" onclick="enviarMensajeSoporte()">ENVIAR AL DOCENTE</button>
      </div>

      <div id="sop_step_history" style="display:none">
        <h3 style="color:#6a1b9a;">Mis Mensajes y Respuestas</h3>
        <button class="btn sec" style="margin-bottom:15px; font-size:12px; padding:8px;"
          onclick="document.getElementById('sop_step_history').style.display='none'; document.getElementById('sop_step_menu').style.display='block';">
          ‚Üê VOLVER
        </button>
        <div id="listaMensajesRespuestas"></div>
      </div>

    </div>
  </div>

  <button class="btn-support-trigger" onclick="abrirSoporte()">üí¨ Comunicaci√≥n y Soporte</button>

  <!-- ‚úÖ OVERLAY EXCUSA ENVIADA (como tu pantallazo) -->
  <div id="successAsistencia" class="success-overlay" style="background: rgba(27, 94, 32, 0.98);">
    <h2 style="margin:0 0 12px 0;">‚úÖ ¬°Env√≠o Exitoso!</h2>
    <p style="max-width:520px; font-size:18px; line-height:1.5;">
      ‚ÄúRecuerda que es responsabilidad del estudiante ponerse al d√≠a con las actividades correspondientes a la jornada que No asisti√≥.‚Äù
    </p>
    <button class="btn" style="background:white; color:#1b5e20; width:220px; margin-top:18px;" onclick="cerrarOverlayExcusa()">
      ENTENDIDO
    </button>
  </div>

  <!-- ‚úÖ OVERLAY SOPORTE -->
  <div id="successMensaje" class="success-overlay" style="background: rgba(2, 119, 189, 0.98);">
    <h2 style="margin:0 0 12px 0;">‚úÖ Mensaje Enviado</h2>
    <p style="max-width:520px; font-size:18px; line-height:1.5;">
      ‚ÄúApreciado Padre de familia, gracias por comunicarse, procurar√© responder a su solicitud lo m√°s pronto posible.‚Äù
    </p>
    <button class="btn" style="background:white; color:#0277bd; width:220px; margin-top:18px;" onclick="location.reload()">
      ENTENDIDO
    </button>
  </div>

  <!-- ‚úÖ OVERLAY OBSERVACIONES (din√°mico verde/amarillo/rojo) -->
  <div id="overlayObs" class="success-overlay" style="display:none;">
    <h2 id="overlayObsTitle" style="margin:0 0 10px 0;">‚úÖ Confirmaci√≥n</h2>
    <p id="overlayObsText" style="max-width:520px; font-size:16px; line-height:1.5;"></p>
    <button class="btn" id="overlayObsBtn" style="background:white; width:220px; margin-top:18px;" onclick="cerrarOverlayObs()">
      ENTENDIDO
    </button>
  </div>

  <div class="footer">‚ÄúFamilia y escuela caminamos juntos‚Äù</div>
  <div id="toast">üîî ¬°Atenci√≥n! Tienes nuevas observaciones recientes.</div>

<script>
  // ESTUDIANTES
  const estudiantesValidos = [
    { doc: "1157463842", nombre: "BERRIO CORREA VALENTINA" },
    { doc: "1038213324", nombre: "GUZMAN CORREA DYLAN" },
    { doc: "1072263423", nombre: "MEDINA POLO JESUS DAVID" },
    { doc: "1041636093", nombre: "MEJIA VALLEJO TOMAS" },
    { doc: "1041636021", nombre: "VARELAS BARRIENTOS MAXIMILIANO" }
  ];

  // PERIODO (Firebase)
  let periodoActualAsis = 1;

  // Fechas (Asistencia)
  let fechasFallas = [];
  let fechasExcusas = [];

  // Soporte
  let estActualSoporte = null;

  // Observaciones: doc actual
  let currentDocObs = "";

  function setRibbonPeriodo(numero){
    const el = document.getElementById("ribbonPeriodo");
    if(!el) return;
    el.textContent = `PERIODO: ${numero} (ASISTENCIA)`;
  }

  async function cargarPeriodoDesdeFirebase(){
    try{
      const snap = await db.collection("configuracionGlobal").doc("asistencia").get();
      if(snap.exists){
        const data = snap.data() || {};
        periodoActualAsis = Number(data.periodoActual || 1);
      } else {
        await db.collection("configuracionGlobal").doc("asistencia").set({ periodoActual: 1 });
        periodoActualAsis = 1;
      }
    } catch(e){
      periodoActualAsis = 1;
    }
    setRibbonPeriodo(periodoActualAsis);
  }

  function normalizarFecha(value){
    if(!value) return null;
    if(typeof value === "object" && typeof value.toDate === "function"){
      const d = value.toDate();
      return d.toISOString().slice(0,10);
    }
    if(typeof value === "string"){
      if(/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
      const m = value.match(/^(\d{4}-\d{2}-\d{2})/);
      if(m) return m[1];
      return value;
    }
    return null;
  }

  // CARGAR DOCUMENTO GUARDADO
  window.onload = async function() {
    const savedDoc = localStorage.getItem("padres_doc_estudiante");
    if(savedDoc) {
      document.getElementById("docObs").value = savedDoc;
      document.getElementById("docExc").value = savedDoc;
      document.getElementById("docSoporte").value = savedDoc;
      document.getElementById("chkRemObs").checked = true;
      document.getElementById("chkRemExc").checked = true;
    }
    await cargarPeriodoDesdeFirebase();
  };

  // ==========================
  // ‚úÖ OBSERVACIONES (restaurado)
  // ==========================
  let unsubscribeObs = null;
  const audioNotif = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');

  function notificarNovedad() {
    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
    audioNotif.play().catch(e => {});
    const x = document.getElementById("toast");
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 5000);
  }

  function buscarObservaciones() {
    const docInput = document.getElementById("docObs").value.trim();
    currentDocObs = docInput;

    const remember = document.getElementById("chkRemObs").checked;
    const out = document.getElementById("resultadoObs");
    const btn = document.getElementById("btnBuscar");

    if(!docInput) { alert("Digite documento."); return; }

    if(remember) localStorage.setItem("padres_doc_estudiante", docInput);
    else localStorage.removeItem("padres_doc_estudiante");

    if(unsubscribeObs) unsubscribeObs();

    btn.disabled = true;
    btn.textContent = "CONECTANDO...";
    out.innerHTML = "<div style='text-align:center; padding:20px;'>Sincronizando...</div>";

    const storageKey = 'count_' + docInput;
    let lastCount = parseInt(localStorage.getItem(storageKey) || "0");

    unsubscribeObs = db.collection("registrosComportamentales")
      .where("documentoEstudiante", "==", docInput)
      .onSnapshot(snapshot => {
        btn.disabled = false;
        btn.textContent = "ACTUALIZAR ESTADO";

        if(snapshot.empty) { out.innerHTML = "<p style='text-align:center'>No hay registros.</p>"; return; }

        const currentCount = snapshot.size;
        if (currentCount > lastCount) {
           notificarNovedad();
           localStorage.setItem(storageKey, currentCount);
        } else if (lastCount === 0) {
           localStorage.setItem(storageKey, currentCount);
        }

        let docs = [];
        snapshot.forEach(d => docs.push({ id:d.id, ...d.data() }));
        docs.sort((a,b) => (a.timestamp || a.fecha).localeCompare(b.timestamp || b.fecha));

        docs = docs.map((r, index) => {
            const num = index + 1;
            let color = "#4caf50";
            if(num === 2) color = "#ff9800";
            else if(num >= 3) color = "#f44336";
            return { ...r, numSec: num, colorTema: color };
        });

        docs.reverse();
        renderizarObs(docs, currentCount > lastCount);
      });
  }

  function renderizarObs(items, hayNovedad) {
    let html = "";
    items.forEach((r, idx) => {
        const firmado = !!r.firmaAcudiente;
        const esNuevo = (idx === 0 && hayNovedad && !firmado);
        html += `
            <div class="card ${esNuevo ? 'new-item' : ''}">
                <div class="top" style="background:${r.colorTema}">
                    <div>REGISTRO N¬∞ ${r.numSec} ${esNuevo ? '<span class="new-tag">¬°NUEVO!</span>' : ''}</div>
                    <div class="badge">${firmado ? "FIRMADO ‚úÖ" : "PENDIENTE ‚úçÔ∏è"}</div>
                </div>
                <div class="body">
                    <div class="row"><b>Fecha:</b> ${r.fecha}</div>
                    <div class="row"><b>Comportamiento:</b> ${r.comportamiento}</div>
                    <div class="row"><b>Descargos:</b> ${r.descargos || 'Ninguno'}</div>
                    <div class="row"><b>Procedimiento:</b> ${r.procedimiento || ''}</div>
                    <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                        ${firmado ? `
                            <div style="text-align:center">
                                <div style="color:#2e7d32; font-weight:bold; font-size:11px;">‚úì Firmado por Acudiente</div>
                                <img src="${r.firmaAcudiente}" style="max-height:70px;">
                            </div>
                        ` : `
                            <div class="sig-wrap" style="background:#fff9c4;">
                                <div style="font-size:11px; text-align:center; font-weight:bold; margin-bottom:5px;">‚úçÔ∏è FIRMA RECIBIDO</div>
                                <canvas id="cv_${r.id}"></canvas>
                                <div class="sig-actions">
                                    <button class="btn sec" onclick="limpiarPad('cv_${r.id}')">BORRAR</button>
                                    <button class="btn" onclick="firmarRegistro('${r.id}')">CONFIRMAR</button>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            </div>`;
    });
    document.getElementById("resultadoObs").innerHTML = html;
    setTimeout(() => { items.forEach(r => { if(!r.firmaAcudiente) initPad("cv_"+r.id); }); }, 200);
  }

  // ‚úÖ Overlay Observaciones por # firmas
  function cerrarOverlayObs(){
    const o = document.getElementById("overlayObs");
    if(o) o.style.display = "none";
  }

  function mostrarOverlayObsPorFirmas(totalFirmadas){
    const o = document.getElementById("overlayObs");
    const t = document.getElementById("overlayObsText");
    const btn = document.getElementById("overlayObsBtn");
    if(!o || !t || !btn) return;

    let bg = "rgba(34, 197, 94, 0.92)";  // verde claro
    let btnColor = "#166534";
    let msg = "Apreciado padre de familia, le recordamos que si su hijo acumula tres observaciones, usted ser√° citado a una entrevista con el docente, con el prop√≥sito de analizar la situaci√≥n y fortalecer sus procesos acad√©micos y disciplinarios.";

    if(totalFirmadas === 2){
      bg = "rgba(250, 204, 21, 0.92)";   // amarillo
      btnColor = "#92400e";
      msg = "Apreciado padre de familia, le recordamos que si su hijo acumula tres observaciones, usted ser√° citado a una entrevista con el docente, con el prop√≥sito de analizar la situaci√≥n y fortalecer sus procesos acad√©micos y disciplinarios.";
    }

    if(totalFirmadas >= 3){
      bg = "rgba(239, 68, 68, 0.95)";    // rojo
      btnColor = "#7f1d1d";
      msg = "Apreciado padre de familia, su hijo ha acumulado tres observaciones; por tal motivo, es importante que acuda a la instituci√≥n para que, junto con el docente, se establezcan compromisos orientados al mejoramiento acad√©mico y disciplinario de su hijo.";
    }

    o.style.background = bg;
    t.textContent = msg;
    btn.style.color = btnColor;
    o.style.display = "flex";
  }

  async function firmarRegistro(id) {
    const p = pads.get("cv_"+id);
    if(!p?.hasData) return alert("Firme primero.");

    await db.collection("registrosComportamentales").doc(id).update({
      firmaAcudiente: p.c.toDataURL(),
      fechaFirmaAcudiente: new Date().toISOString()
    });

    try{
      if(!currentDocObs){
        alert("‚úÖ Firma guardada.");
        return;
      }

      const snap = await db.collection("registrosComportamentales")
        .where("documentoEstudiante", "==", currentDocObs)
        .get();

      let firmadas = 0;
      snap.forEach(doc => {
        const d = doc.data();
        if(d && d.firmaAcudiente) firmadas++;
      });

      mostrarOverlayObsPorFirmas(firmadas);

    } catch(e){
      alert("‚úÖ Firma guardada.");
    }
  }

  // ==========================
  // ‚úÖ ASISTENCIA (manteniendo l√≥gica)
  // ==========================
  async function activarFormularioExcusa() {
    const docInput = document.getElementById("docExc").value.trim();
    const est = estudiantesValidos.find(e => e.doc === docInput);
    if(!est) return alert("No encontrado");

    if(document.getElementById("chkRemExc").checked) localStorage.setItem("padres_doc_estudiante", docInput);
    else localStorage.removeItem("padres_doc_estudiante");

    document.getElementById("btnInitExc").style.display="none";
    document.getElementById("contenedorFormExc").style.display="block";

    document.getElementById("ribbonNombre").textContent = est.nombre;

    await cargarPeriodoDesdeFirebase();
    await consultarEstadisticasYFechas(docInput);

    setTimeout(() => initPad('sigExc'), 200);
  }

  async function consultarEstadisticasYFechas(docId) {
    const snap = await db.collection("controlAsistencia").get();

    let fallas = 0, excusas = 0;
    fechasFallas = [];
    fechasExcusas = [];

    snap.forEach(d => {
      const data = d.data() || {};
      const per = Number(data.periodo || 1);
      if(per !== periodoActualAsis) return;

      const fecha = normalizarFecha(data.fecha || data.fechaAsistencia || data.timestamp);
      const reg = data.detalles?.find(x => x.doc === docId);

      if(reg?.estado === 'I') { fallas++; if(fecha) fechasFallas.push(fecha); }
      if(reg?.estado === 'E') { excusas++; if(fecha) fechasExcusas.push(fecha); }
    });

    fechasFallas.sort();
    fechasExcusas.sort();

    document.getElementById("statFallas").innerText = fallas;
    document.getElementById("statExcusas").innerText = excusas;

    const total = fallas + excusas;
    if(total >= 3){
      document.getElementById("statEstado").innerText = "ALERTA";
      document.getElementById("boxEstado").style.background = "#d32f2f";
    } else {
      document.getElementById("statEstado").innerText = "OK";
      document.getElementById("boxEstado").style.background = "#22c55e";
    }
  }

  function mostrarFechas(tipo){
    const modal = document.getElementById("modalFechas");
    const titulo = document.getElementById("mfTitulo");
    const sub = document.getElementById("mfSub");
    const cont = document.getElementById("mfContenido");

    const lista = (tipo === "fallas") ? fechasFallas : fechasExcusas;
    const label = (tipo === "fallas") ? "Fallas (Inasistencias injustificadas)" : "Excusas (Inasistencias excusadas)";

    titulo.childNodes[titulo.childNodes.length - 1].nodeValue = ` ${label}`;
    sub.textContent = `Periodo ${periodoActualAsis}`;

    if(!lista.length){
      cont.innerHTML = `<div class="mf-empty">No hay fechas registradas para este periodo.</div>`;
    } else {
      cont.innerHTML = `<ol class="mf-list">${lista.map(f => `<li>${f}</li>`).join("")}</ol>`;
    }
    modal.style.display = "block";
  }

  function cerrarModalFechas(){
    document.getElementById("modalFechas").style.display = "none";
  }

  function validarCamposExcusa() {
    const doc = document.getElementById("docExc").value.trim();
    const fecha = document.getElementById("fechaExc").value;
    const motivo = document.getElementById("motivoExc").value;
    const detalle = document.getElementById("detalleExc").value.trim();
    const p = pads.get("sigExc");

    if(!doc) return "Digite el documento del estudiante.";
    if(!fecha) return "Seleccione la fecha de inasistencia.";
    if(!motivo) return "Seleccione el motivo.";
    if(!detalle) return "Escriba los detalles del motivo.";
    if(detalle.length < 10) return "Los detalles est√°n muy cortos. Escriba un poquito m√°s (m√≠nimo 10 caracteres).";
    if(!p?.hasData) return "La firma es obligatoria.";
    return null;
  }

  function cerrarOverlayExcusa(){
    document.getElementById("successAsistencia").style.display = "none";
    location.reload();
  }

  async function enviarExcusa() {
    const error = validarCamposExcusa();
    if(error) return alert("‚ö†Ô∏è " + error);

    const btn = document.getElementById("btnEnviarExc");
    btn.disabled = true;
    btn.textContent = "ENVIANDO...";

    try {
      const p = pads.get("sigExc");
      await db.collection("excusasInasistencia").add({
        documentoEstudiante: document.getElementById("docExc").value.trim(),
        fechaInasistencia: document.getElementById("fechaExc").value,
        motivoTipo: document.getElementById("motivoExc").value,
        motivoDetalle: document.getElementById("detalleExc").value.trim(),
        firmaAcudiente: p.c.toDataURL(),
        periodo: periodoActualAsis,
        timestamp: new Date().toISOString()
      });

      document.getElementById("successAsistencia").style.display = "flex";

    } catch(e) {
      alert("‚ùå Error enviando la excusa. Intente de nuevo.");
      btn.disabled = false;
      btn.textContent = "ENVIAR EXCUSA";
    }
  }

  // ==========================
  // ‚úÖ SOPORTE / COMUNICACI√ìN
  // ==========================
  function abrirSoporte() { document.getElementById("modalSoporte").style.display = "block"; }
  function cerrarSoporte() { document.getElementById("modalSoporte").style.display = "none"; }

  function autenticarSoporte() {
    const doc = document.getElementById("docSoporte").value.trim();
    const est = estudiantesValidos.find(e => e.doc === doc);
    if(est) {
      estActualSoporte = est;
      if(doc) localStorage.setItem("padres_doc_estudiante", doc);

      document.getElementById("sop_step_auth").style.display = "none";
      document.getElementById("sop_step_menu").style.display = "block";
      document.getElementById("sop_nombre_est").innerText = "Estudiante: " + est.nombre;
    } else alert("Documento no encontrado.");
  }

  function irAInfoComunicacion() {
    document.getElementById("sop_step_menu").style.display = "none";
    document.getElementById("sop_step_info").style.display = "block";
  }

  function irAFormularioMsg() {
    document.getElementById("sop_step_info").style.display = "none";
    document.getElementById("sop_step_form").style.display = "block";
    document.getElementById("msg_fecha").valueAsDate = new Date();
    setTimeout(() => initPad('sigSoporte'), 200);
  }

  async function enviarMensajeSoporte() {
    const p = pads.get("sigSoporte");
    const asunto = document.getElementById("msg_asunto").value.trim();
    const texto = document.getElementById("msg_texto").value.trim();
    const fecha = document.getElementById("msg_fecha").value;

    if(!estActualSoporte) return alert("‚ö†Ô∏è Primero autent√≠quese.");
    if(!asunto || !texto || !fecha || !p?.hasData) return alert("‚ö†Ô∏è Por favor, complete la fecha, el asunto, el contenido y firme.");

    const btn = document.getElementById("btnEnviarSop");
    btn.disabled = true;
    btn.textContent = "ENVIANDO...";

    try {
      await db.collection("comunicacionPadres").add({
        documentoEstudiante: estActualSoporte.doc,
        nombreEstudiante: estActualSoporte.nombre,
        fechaMsg: fecha,
        asunto: asunto,
        mensaje: texto,
        firma: p.c.toDataURL(),
        timestamp: new Date().toISOString()
      });
      document.getElementById("successMensaje").style.display = "flex";
    } catch(e) {
      alert("‚ùå Error enviando el mensaje. Intente de nuevo.");
      btn.disabled = false;
      btn.textContent = "ENVIAR AL DOCENTE";
    }
  }

  function irAHistorialMensajes() {
    if(!estActualSoporte) return alert("‚ö†Ô∏è Primero autent√≠quese.");

    document.getElementById("sop_step_menu").style.display = "none";
    document.getElementById("sop_step_history").style.display = "block";

    db.collection("comunicacionPadres")
      .where("documentoEstudiante", "==", estActualSoporte.doc)
      .onSnapshot(snap => {
        let html = "";
        snap.forEach(d => {
          const m = d.data();
          html += `
            <div class="history-card">
              <div class="history-header">
                <span style="font-weight:900">${(m.asunto || '').toString().slice(0,60)}</span>
                <span>${m.fechaMsg || ''}</span>
              </div>
              <div class="history-body">${(m.mensaje || '').toString()}</div>
              ${m.respuestaDocente ? `<div class="teacher-reply">${m.respuestaDocente}</div>` : ''}
            </div>
          `;
        });
        document.getElementById("listaMensajesRespuestas").innerHTML = html || "Sin mensajes.";
      });
  }

  // ==========================
  // ‚úÖ PADS (firma)
  // ==========================
  const pads = new Map();

  function initPad(id){
    const c = document.getElementById(id); if(!c) return;
    const ctx = c.getContext("2d");
    const ratio = window.devicePixelRatio || 1;
    const rect = c.getBoundingClientRect();

    c.width = rect.width * ratio;
    c.height = 180 * ratio;
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";

    let drawing = false;

    const getPos = (e) => {
      const r = c.getBoundingClientRect();
      return {
        x: (e.touches ? e.touches[0].clientX : e.clientX) - r.left,
        y: (e.touches ? e.touches[0].clientY : e.clientY) - r.top
      };
    };

    const start = (e) => {
      drawing = true;
      ctx.beginPath();
      const p = getPos(e);
      ctx.moveTo(p.x, p.y);
      pads.set(id, {ctx, c, hasData:false});
    };

    const move = (e) => {
      if(!drawing) return;
      const p = getPos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      const prev = pads.get(id) || {ctx, c, hasData:true};
      pads.set(id, { ...prev, ctx, c, hasData:true });
    };

    const end = () => { drawing = false; };

    c.onmousedown = (e) => start(e);
    c.onmousemove = (e) => move(e);
    window.addEventListener("mouseup", end);

    c.addEventListener("touchstart", (e) => { e.preventDefault(); start(e); }, {passive:false});
    c.addEventListener("touchmove", (e) => { e.preventDefault(); move(e); }, {passive:false});
    c.addEventListener("touchend", end, {passive:true});

    if(!pads.has(id)) pads.set(id, {ctx, c, hasData:false});
  }

  function limpiarPad(id) {
    const p = pads.get(id);
    if(p) { p.ctx.clearRect(0,0,p.c.width,p.c.height); p.hasData=false; }
  }

  // ==========================
  // ‚úÖ NAV
  // ==========================
  function verObs(){
    document.getElementById("obs").style.display="block";
    document.getElementById("exc").style.display="none";
    document.getElementById("btnObs").classList.add("active");
    document.getElementById("btnExc").classList.remove("active");
  }
  function verExc(){
    document.getElementById("obs").style.display="none";
    document.getElementById("exc").style.display="block";
    document.getElementById("btnExc").classList.add("active");
    document.getElementById("btnObs").classList.remove("active");
  }
</script>

</body>
</html>
