<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<title>Seguimiento de Procesos Escolares ¬∑ Primaria 2026</title>
<meta name="theme-color" content="#1b5e20" />

<!-- Optimizaci√≥n para APK -->
<meta name="mobile-web-app-capable" content="yes">

<style>
  /* Base y Reset */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: system-ui, Arial, sans-serif; background: #dff5e1; padding-bottom: 95px; user-select: none; }
  
  /* ENCABEZADO */
  .header { background: #1b5e20; color: #fff; text-align: center; padding: 20px 16px 35px; border-radius: 0 0 30px 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .header img { width: 90px; margin-bottom: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); display: inline-block; }
  .header h2 { margin: 5px 0; font-size: 22px; letter-spacing: -0.5px; }
  .header h4 { margin: 5px 0; font-weight: 500; opacity: 0.9; font-size: 14px; }
  .header strong { display: block; margin-top: 8px; font-size: 15px; color: #a5d6a7; }
  .header p { margin: 5px 0 0; font-size: 13px; opacity: 0.8; }

  /* MEN√ö FLOTANTE */
  .menu { display: flex; justify-content: space-around; gap: 10px; background: #2e7d32; padding: 8px; margin: -25px auto 20px; width: 92%; border-radius: 999px; box-shadow: 0 6px 12px rgba(0,0,0,0.15); position: relative; z-index: 10; }
  .menu button { flex: 1; border: none; padding: 12px 14px; border-radius: 999px; font-weight: 800; cursor: pointer; background: rgba(255,255,255,0.1); color: #fff; transition: all 0.2s; font-size: 14px; }
  .menu button.active { background: #fff; color: #1b5e20; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  /* CONTENEDOR PRINCIPAL */
  .container { background: #fff; width: 92%; margin: 10px auto; padding: 20px 16px; border-radius: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
  
  /* FORMULARIOS */
  .input-label { font-weight: 700; color: #1b5e20; font-size: 13px; margin-left: 4px; margin-bottom: 4px; display: block; }
  input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 16px; background: #f9f9f9; transition: border 0.3s; appearance: none; -webkit-appearance: none; }
  input:focus, textarea:focus, select:focus { outline: none; border-color: #1b5e20; background: #fff; }
  textarea { min-height: 110px; resize: none; }

  /* RECORDAR DOCUMENTO */
  .remember-box { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; color: #555; }
  .remember-box input { width: auto; margin: 0; }

  /* BOTONES */
  .btn { width: 100%; padding: 15px; background: #1b5e20; color: #fff; font-weight: 800; border: none; border-radius: 14px; cursor: pointer; font-size: 15px; box-shadow: 0 4px 0 #145018; margin-top: 5px; }
  .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #145018; }
  .btn.sec { background: #546e7a; box-shadow: 0 4px 0 #37474f; }
  .btn:disabled { opacity: 0.6; cursor: wait; }

  /* TARJETAS OBSERVACIONES */
  .card { margin-top: 15px; border-radius: 16px; overflow: hidden; border: 1px solid #eee; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
  .card .top { padding: 10px 12px; font-weight: 900; color: #fff; display: flex; justify-content: space-between; align-items: center; }
  .badge { padding: 4px 8px; border-radius: 6px; background: rgba(0,0,0,0.2); font-size: 11px; font-weight: 800; letter-spacing: 0.5px; }
  .card .body { padding: 15px; color: #333; font-size: 14px; line-height: 1.5; }
  
  .row { margin-top: 10px; }
  .row b { display: block; margin-bottom: 3px; color: #1b5e20; font-size: 12px; text-transform: uppercase; }
  
  /* TARJETA ASISTENCIA */
  .att-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
  .att-summary { display: flex; gap: 10px; margin-bottom: 10px; }
  .att-box { flex: 1; text-align: center; padding: 10px 5px; border-radius: 10px; color: #fff; }
  .att-red { background: #ef4444; }
  .att-orange { background: #f97316; }
  .att-green { background: #22c55e; }
  .att-num { font-size: 20px; font-weight: 800; display: block; }
  .att-lbl { font-size: 10px; text-transform: uppercase; font-weight: 700; opacity: 0.9; }
  
  .att-list { font-size: 13px; color: #475569; border-top: 1px dashed #cbd5e1; padding-top: 10px; }
  .att-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
  .badge-fail { color: #dc2626; background: #fee2e2; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; }
  .badge-exc { color: #ea580c; background: #ffedd5; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; }

  /* FIRMA */
  .sig-wrap { margin-top: 15px; padding: 10px; border-radius: 14px; background: #f1f5f9; border: 2px dashed #b0bec5; }
  canvas { width: 100%; height: 180px; border-radius: 8px; background: #fff; touch-action: none; display: block; }
  .sig-actions { display: flex; gap: 10px; margin-top: 10px; }
  .sig-actions button { flex: 1; padding: 10px; font-size: 13px; min-width: 0; box-shadow: none !important; margin-top: 0; }
  .sig-actions button.primary { background: #1b5e20; color: #fff; }

  .footer { margin: 30px 18px 10px; text-align: center; font-size: 13px; font-weight: 600; color: #145018; opacity: 0.8; padding-bottom: 20px; line-height: 1.4; }
  
  /* ESTILO PARA NUEVO ITEM */
  .new-item { border: 2px solid #d32f2f; animation: pulse 2s infinite; }
  .new-tag { background: #d32f2f; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 5px; vertical-align: middle; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }

  #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
  #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 4.5s; }
  @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
  @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
  firebase.initializeApp({
    apiKey: "AIzaSyB2MJ-jdwQeT6sOfZ21tCrFYzGiuTNOAJ8",
    authDomain: "diariodeprocesos-6f78d.firebaseapp.com",
    projectId: "diariodeprocesos-6f78d"
  });
  const db = firebase.firestore();
</script>
</head>

<body>

  <div class="header">
    <img src="escudo.png" alt="Escudo I.E. De Mar√≠a" onerror="this.onerror=null; this.src='https://placehold.co/100x100/1b5e20/ffffff?text=IE+De+Maria';">
    <h2>Instituci√≥n Educativa de Mar√≠a</h2>
    <h4>Sede Rural Santa Juana ¬∑ Primaria 2026</h4>
    <strong>Docente: Oscar Barrientos</strong>
    <p>Seguimiento de Procesos Escolares</p>
  </div>

  <div class="menu">
    <button id="btnObs" class="active" onclick="verObs()">Observaciones</button>
    <button id="btnExc" onclick="verExc()">Excusas / Asistencia</button>
  </div>

  <!-- SECCI√ìN OBSERVACIONES -->
  <div id="obs" class="container">
    <span class="input-label">DOCUMENTO DEL ESTUDIANTE</span>
    <input id="docObs" type="number" placeholder="Digite documento..." inputmode="numeric">
    
    <!-- CHECKBOX PARA RECORDAR -->
    <div class="remember-box">
        <input type="checkbox" id="chkRemObs">
        <label for="chkRemObs">Recordar en este dispositivo</label>
    </div>

    <button id="btnBuscar" class="btn" onclick="buscarObservaciones()">VER OBSERVACIONES</button>
    <div id="resultadoObs" style="margin-top:20px;"></div>
  </div>

  <!-- SECCI√ìN EXCUSAS Y ASISTENCIA -->
  <div id="exc" class="container" style="display:none;">
    
    <!-- PASO 1: SOLO DOCUMENTO -->
    <span class="input-label">DOCUMENTO DEL ESTUDIANTE</span>
    <input id="docExc" type="number" placeholder="Digite documento..." inputmode="numeric">
    
    <!-- CHECKBOX PARA RECORDAR -->
    <div class="remember-box">
        <input type="checkbox" id="chkRemExc">
        <label for="chkRemExc">Recordar en este dispositivo</label>
    </div>

    <button id="btnInitExc" class="btn" onclick="activarFormularioExcusa()">CONTINUAR</button>

    <!-- PASO 2: CONTENIDO OCULTO -->
    <div id="contenedorFormExc" style="display:none; border-top:1px solid #eee; padding-top:20px; margin-top:20px;">
        
        <div id="nombreExc" style="font-weight:bold; color:#1b5e20; margin-bottom:15px; font-size:15px; text-align:center; background:#e8f5e9; padding:10px; border-radius:8px;">
            Verificando estudiante...
        </div>

        <div class="att-card">
            <div style="font-weight:700; color:#334155; margin-bottom:10px; font-size:14px;">üìä Reporte de Asistencia</div>
            <div id="loadingAtt" style="text-align:center; font-size:12px; color:#666;">Consultando registros...</div>
            <div id="attContent" style="display:none;">
                <div class="att-summary">
                    <div class="att-box att-red"><span class="att-num" id="countI">0</span><span class="att-lbl">Fallas</span></div>
                    <div class="att-box att-orange"><span class="att-num" id="countE">0</span><span class="att-lbl">Excusas</span></div>
                    <div class="att-box att-green"><span class="att-num">OK</span><span class="att-lbl">Estado</span></div>
                </div>
                <div class="att-list" id="attListDetails"></div>
            </div>
        </div>

        <h3 style="margin-bottom:10px; border-bottom:2px solid #eee; padding-bottom:5px;">Enviar Excusa</h3>

        <span class="input-label">FECHA DE INASISTENCIA</span>
        <input id="fechaExc" type="date">

        <span class="input-label">MOTIVO</span>
        <select id="motivoExc">
        <option value="Enfermedad">Enfermedad</option>
        <option value="Cita m√©dica">Cita m√©dica</option>
        <option value="Calamidad">Calamidad</option>
        <option value="Otro">Otro</option>
        </select>

        <span class="input-label">DETALLES</span>
        <textarea id="detalleExc" placeholder="Escriba el detalle del motivo..."></textarea>

        <span class="input-label">FIRMA DEL ACUDIENTE</span>
        <div class="sig-wrap">
        <canvas id="sigExc"></canvas>
        <div class="sig-actions">
            <button class="btn sec" onclick="limpiarPad('sigExc')">Borrar Firma</button>
        </div>
        </div>

        <button id="btnEnviarExc" class="btn" onclick="enviarExcusa()">ENVIAR EXCUSA</button>
    </div>
  </div>

  <div class="footer">
    ‚ÄúFamilia y escuela caminamos juntos: al colaborar y comunicarnos,
    construimos el mejor camino para el bienestar y aprendizaje de nuestros hijos.‚Äù
  </div>

  <div id="toast">üîî ¬°Atenci√≥n! Tienes nuevas observaciones recientes.</div>

<script>
  // --- LISTA DE ESTUDIANTES V√ÅLIDOS ---
  const estudiantesValidos = [
    { doc: "1157463842", nombre: "BERRIO CORREA VALENTINA" },
    { doc: "1038213324", nombre: "GUZMAN CORREA DYLAN" },
    { doc: "1072263423", nombre: "MEDINA POLO JESUS DAVID" },
    { doc: "1041636093", nombre: "MEJIA VALLEJO TOMAS" },
    { doc: "1041636021", nombre: "VARELAS BARRIENTOS MAXIMILIANO" }
  ];

  // --- CARGAR DOCUMENTO GUARDADO AL INICIAR ---
  window.onload = function() {
      const savedDoc = localStorage.getItem("padres_doc_estudiante");
      if(savedDoc) {
          document.getElementById("docObs").value = savedDoc;
          document.getElementById("docExc").value = savedDoc;
          document.getElementById("chkRemObs").checked = true;
          document.getElementById("chkRemExc").checked = true;
      }
  };

  // --- NAVEGACI√ìN ---
  function verObs(){
    document.getElementById("obs").style.display="block";
    document.getElementById("exc").style.display="none";
    document.getElementById("btnObs").classList.add("active");
    document.getElementById("btnExc").classList.remove("active");
  }
  
  function verExc(){
    document.getElementById("obs").style.display="none";
    document.getElementById("exc").style.display="block";
    document.getElementById("btnExc").classList.add("active");
    document.getElementById("btnObs").classList.remove("active");
    
    // Si ya est√° guardado el documento, no reseteamos
    const savedDoc = localStorage.getItem("padres_doc_estudiante");
    if(!savedDoc) {
        resetFormularioExcusa();
    }
  }

  function resetFormularioExcusa() {
    document.getElementById("contenedorFormExc").style.display = "none";
    document.getElementById("btnInitExc").style.display = "block";
  }

  // --- L√ìGICA DE APERTURA ---
  async function activarFormularioExcusa() {
      const doc = document.getElementById("docExc").value.trim();
      const remember = document.getElementById("chkRemExc").checked;

      if(!doc) { alert("Por favor digite el documento del estudiante."); return; }

      const estudiante = estudiantesValidos.find(e => e.doc === doc);
      if (!estudiante) {
          alert("‚ùå Documento no encontrado.\n\nVerifique que el n√∫mero est√© bien escrito.");
          return; 
      }

      // GUARDAR EN LOCALSTORAGE SI EL CHECK EST√Å ACTIVO
      if(remember) {
          localStorage.setItem("padres_doc_estudiante", doc);
      } else {
          localStorage.removeItem("padres_doc_estudiante");
      }

      document.getElementById("btnInitExc").style.display = "none";
      document.getElementById("contenedorFormExc").style.display = "block";
      document.getElementById("nombreExc").innerText = "Estudiante: " + estudiante.nombre;

      consultarHistorialAsistencia(doc);
      setTimeout(()=>initPad('sigExc'), 100);
  }

  // --- BUSCADOR OBSERVACIONES ---
  let unsubscribe = null;
  function buscarObservaciones(){
    const doc = document.getElementById("docObs").value.trim();
    const remember = document.getElementById("chkRemObs").checked;
    const out = document.getElementById("resultadoObs");
    const btn = document.getElementById("btnBuscar");

    if(!doc){ alert("Por favor, digite el documento."); return; }

    // GUARDAR PREFERENCIA
    if(remember) {
        localStorage.setItem("padres_doc_estudiante", doc);
    } else {
        localStorage.removeItem("padres_doc_estudiante");
    }

    if(unsubscribe) unsubscribe();

    btn.disabled = true;
    btn.textContent = "CONECTANDO...";
    out.innerHTML = "<div style='text-align:center; padding:20px; color:#666;'>Sincronizando observaciones...</div>";

    const storageKey = 'count_' + doc;
    let lastCount = parseInt(localStorage.getItem(storageKey) || "0");

    unsubscribe = db.collection("registrosComportamentales")
      .where("documentoEstudiante","==",doc)
      .onSnapshot(snapshot => {
        btn.disabled = false;
        btn.textContent = "ACTUALIZAR ESTADO";

        if(snapshot.empty){
          out.innerHTML = "<div style='text-align:center; padding:20px;'><strong>No se encontraron registros.</strong></div>";
          return;
        }

        const currentCount = snapshot.size;
        if (currentCount > lastCount) {
           notificarNovedad();
           localStorage.setItem(storageKey, currentCount);
        } else if (lastCount === 0) {
           localStorage.setItem(storageKey, currentCount);
        }

        let docs = [];
        snapshot.forEach(d => docs.push({ id:d.id, ...d.data() }));
        
        // ----------------------------------------------------
        // L√ìGICA CORREGIDA DE ORDENAMIENTO (TIMESTAMPS)
        // ----------------------------------------------------
        
        // Ordenamos por TIMESTAMP si existe, o por fecha como respaldo.
        // Esto evita el error cuando hay varias notas el mismo d√≠a.
        docs.sort((a,b) => {
            // Preferencia 1: Timestamp (Hora exacta)
            if(a.timestamp && b.timestamp) {
                return a.timestamp.localeCompare(b.timestamp);
            }
            // Preferencia 2: Fecha simple (si no hay timestamp, aunque el archivo docente s√≠ lo guarda)
            return (a.fecha || "").localeCompare(b.fecha || "");
        });

        // 2. Asignar los n√∫meros y colores en orden CRONOL√ìGICO (1=Viejo/Verde ... 3=Nuevo/Rojo)
        docs = docs.map((r, index) => {
            const num = index + 1;
            let colorCode = "#4caf50"; // Verde (Registro #1)
            
            if(num === 2) colorCode = "#ff9800"; // Naranja (Registro #2)
            else if(num >= 3) colorCode = "#f44336"; // Rojo (Registro #3+)

            return { ...r, numSecuencial: num, colorTema: colorCode };
        });

        // 3. INVERTIR para visualizaci√≥n (El m√°s nuevo queda ARRIBA)
        docs.reverse();

        renderizar(docs, currentCount > lastCount);
      }, err => {
        console.error(err);
        btn.disabled = false;
        btn.textContent = "REINTENTAR";
        out.innerHTML = "Error de conexi√≥n.";
      });
  }

  function renderizar(items, hayNovedad){
    let html = "";
    
    items.forEach((r, idx)=>{
      const n = r.numSecuencial; // Usamos el n√∫mero calculado cronol√≥gicamente
      const color = r.colorTema;
      const firmado = !!r.firmaAcudiente;
      // Es nuevo si es el primero de la lista VISUAL (o sea, el √∫ltimo cronol√≥gico)
      const esNuevo = (idx === 0 && hayNovedad && !firmado); 
      const tipo = r.tipoRegistro || "Comportamental";

      html += `
        <div class="card ${esNuevo ? 'new-item' : ''}">
          <div class="top" style="background:${color}">
            <div>REGISTRO N¬∞ ${n} ${esNuevo ? '<span class="new-tag">¬°NUEVO!</span>' : ''}</div>
            <div class="badge">${firmado ? "FIRMADO ‚úÖ" : "PENDIENTE ‚úçÔ∏è"}</div>
          </div>
          <div class="body">
            <div class="row">
                <b>Fecha:</b> <span class="muted">${r.fecha || '--'}</span>
                <span style="float:right; font-size:10px; background:#eee; padding:2px 6px; border-radius:4px;">${tipo}</span>
            </div>
            <div class="row"><b>Comportamiento:</b> ${r.comportamiento || ''}</div>
            <div class="row"><b>Descargos:</b> ${r.descargos || 'Ninguno'}</div>
            <div class="row"><b>Procedimiento:</b> ${r.procedimiento || ''}</div>
            
            <div class="row" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
              ${firmado ? `
                <div style="text-align:center; margin-top:10px;">
                  <div style="color:#2e7d32; font-weight:bold; font-size:12px; margin-bottom:5px;">‚úì Firmado por Acudiente</div>
                  <img src="${r.firmaAcudiente}" style="max-height:80px; border:1px solid #ccc; border-radius:4px;">
                </div>
              ` : `
                <div style="background:#fffde7; padding:10px; border-radius:8px; border:1px solid #fff9c4;">
                  <div style="font-size:12px; color:#f57f17; text-align:center; font-weight:bold; margin-bottom:5px;">
                    üìù Recuerda que debes firmar para notificar al docente el recibido.
                  </div>
                  <div class="sig-wrap" style="background:#fff;">
                    <canvas id="cv_${r.id}"></canvas>
                  </div>
                  <div class="sig-actions">
                    <button class="btn sec" onclick="limpiarPad('cv_${r.id}')">BORRAR</button>
                    <button class="btn primary" onclick="firmarRegistro('${r.id}', ${n})">CONFIRMAR RECIBIDO</button>
                  </div>
                </div>
              `}
              <div style="margin-top:10px; font-size:12px; color:#666; font-style:italic;">
                ${n >= 3 ? "‚ö†Ô∏è Alerta: Esta es la 3ra anotaci√≥n. Se requiere entrevista presencial." : "Nota: A la 3ra anotaci√≥n se citar√° a entrevista."}
              </div>
            </div>
          </div>
        </div>
      `;
    });
    document.getElementById("resultadoObs").innerHTML = html;
    setTimeout(()=>{
      items.forEach(r => { if(!r.firmaAcudiente) initPad(`cv_${r.id}`); });
    }, 100);
  }

  // --- ASISTENCIA ---
  async function consultarHistorialAsistencia(docEst) {
      const listDiv = document.getElementById("attListDetails");
      const loading = document.getElementById("loadingAtt");
      const content = document.getElementById("attContent");
      
      loading.style.display = "block";
      content.style.display = "none";
      listDiv.innerHTML = "";

      let countI = 0;
      let countE = 0;
      
      try {
          const snap = await db.collection("controlAsistencia").get(); 
          let registrosEncontrados = [];

          snap.forEach(diaDoc => {
              const data = diaDoc.data();
              if(data.detalles) {
                  const registroEst = data.detalles.find(d => d.doc === docEst);
                  if(registroEst && (registroEst.estado === 'I' || registroEst.estado === 'E')) {
                      registrosEncontrados.push({
                          fecha: data.fecha,
                          estado: registroEst.estado
                      });
                  }
              }
          });

          registrosEncontrados.sort((a,b) => a.fecha < b.fecha ? 1 : -1);

          if(registrosEncontrados.length === 0) {
              listDiv.innerHTML = "<div style='text-align:center; padding:10px;'>üëè ¬°Excelente! No hay fallas registradas.</div>";
          } else {
              registrosEncontrados.forEach(reg => {
                  if(reg.estado === 'I') countI++;
                  if(reg.estado === 'E') countE++;
                  const label = reg.estado === 'I' ? 'Falla Injustificada' : 'Excusa M√©dica/Calam.';
                  const badgeClass = reg.estado === 'I' ? 'badge-fail' : 'badge-exc';
                  listDiv.innerHTML += `
                    <div class="att-item">
                        <span>üìÖ ${reg.fecha}</span>
                        <span class="${badgeClass}">${label}</span>
                    </div>
                  `;
              });
          }
          document.getElementById("countI").innerText = countI;
          document.getElementById("countE").innerText = countE;
          loading.style.display = "none";
          content.style.display = "block";
      } catch(e) { console.error(e); }
  }

  // --- CANVAS, AUDIO Y ENV√çOS (Sin Cambios L√≥gicos Mayores) ---
  const audioNotif = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');
  function notificarNovedad() {
    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
    audioNotif.play().catch(e => {});
    const x = document.getElementById("toast");
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 5000);
  }

  const pads = new Map();
  function initPad(id){
    const c = document.getElementById(id);
    if(!c) return;
    if(pads.has(id) && pads.get(id).canvas === c) return;
    const ctx = c.getContext("2d");
    const dpr = window.devicePixelRatio || 1;
    const rect = c.getBoundingClientRect();
    c.width = rect.width * dpr;
    c.height = 180 * dpr;
    ctx.scale(dpr, dpr);
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "#000";
    let drawing=false;
    const getPos = (e) => {
      const r = c.getBoundingClientRect();
      const tx = e.touches ? e.touches[0].clientX : e.clientX;
      const ty = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: tx - r.left, y: ty - r.top };
    }
    const start = (e) => { e.preventDefault(); drawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x,p.y); }
    const move = (e) => { if(!drawing)return; e.preventDefault(); const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); pads.set(id, {ctx, c, hasData:true}); }
    const end = () => { drawing=false; }
    c.addEventListener("mousedown", start); c.addEventListener("mousemove", move); window.addEventListener("mouseup", end);
    c.addEventListener("touchstart", start, {passive:false}); c.addEventListener("touchmove", move, {passive:false}); c.addEventListener("touchend", end);
    pads.set(id, {ctx, c, hasData:false});
  }

  function limpiarPad(id){
    const p = pads.get(id);
    if(p){ p.ctx.clearRect(0,0, p.c.width, p.c.height); p.hasData = false; }
  }

  async function firmarRegistro(id, n){
    const p = pads.get("cv_"+id);
    if(!p || !p.hasData){ alert("Por favor, firme en el recuadro blanco."); return; }
    try{
      await db.collection("registrosComportamentales").doc(id).update({
        firmaAcudiente: p.c.toDataURL(),
        fechaFirmaAcudiente: new Date().toISOString()
      });
      alert("‚úÖ Firma guardada correctamente.");
    }catch(e){ alert("Error al guardar: " + e.message); }
  }

  async function enviarExcusa(){
    const doc = document.getElementById("docExc").value;
    const fecha = document.getElementById("fechaExc").value;
    const motivo = document.getElementById("motivoExc").value;
    const detalle = document.getElementById("detalleExc").value;
    const p = pads.get("sigExc");
    if(!doc || !fecha || !detalle){ alert("Complete todos los campos."); return; }
    if(!p || !p.hasData){ alert("Debe firmar la excusa."); return; }
    const btn = document.getElementById("btnEnviarExc");
    btn.disabled = true;
    btn.innerText = "ENVIANDO...";
    try{
      await db.collection("excusasInasistencia").add({
        documentoEstudiante: doc,
        fechaInasistencia: fecha,
        motivoTipo: motivo,
        motivoDetalle: detalle,
        firmaAcudiente: p.c.toDataURL(),
        fechaEnvio: new Date().toISOString()
      });
      alert("‚úÖ Excusa enviada al docente.");
      location.reload();
    }catch(e){
      alert("Error: " + e.message);
      btn.disabled = false;
      btn.innerText = "ENVIAR EXCUSA";
    }
  }
</script>
</body>
</html>
